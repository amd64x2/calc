<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√áizgi Kontrol Paneli</title>
    <style>
        /* CSS Sƒ±fƒ±rlama ve Temel Ayarlar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            height: 100vh;
            position: fixed;
            width: 100vw;
        }

        #main-container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* ------------------------------------- */
        /* HEADER */
        /* ------------------------------------- */
        #info-header {
            width: 100%;
            position: fixed;
            height: 60px;
            top: 0;
            left: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
        }

        .controls-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            justify-content: flex-start;
            align-items: center;
            height: 100%;
            padding: 0 15px;
        }

        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group.full-width {
            width: auto;
            margin: 0;
            padding: 0;
            border: none;
        }

        .input-label {
            min-width: 60px;
            font-weight: bold;
            margin-right: 5px;
            font-size: 15px;
            color: rgb(255, 255, 255);
        }

        .value-control {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2px 5px;
        }

        .value-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 3px;
            transition: background 0.1s;
        }

        .value-btn:active {
            background: #764ba2;
        }

        .value-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            margin: 0 5px;
            font-size: 14px;
        }

        #frameWidth {
            font-size: 14px;
            font-weight: bold;
            color: #44ff44;
            margin-left: 5px;
        }

        /* ------------------------------------- */
        /* FOOTER */
        /* ------------------------------------- */
        #info-footer {
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 100;
            background: rgba(0, 0, 0,0.7);
            pointer-events: none;
            padding: 10px 15px;
        }

        #info-footer>div,
        #info-footer canvas,
        #info-footer * {
            pointer-events: auto;
        }

        #info-footer>div {
            display: grid;
            grid-template-columns: 0.5fr 1fr 1.fr 0.5fr 0.5fr;
            gap: 15px;
            height: 130px;
            max-height: 130px;
        }

        .distance-graphic {
           /* background: rgba(255, 255, 255, 0.05);*/
            border-radius: 4px;
            position: relative;
            padding: 0;
            height: 100%;
            max-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .distance-graphic canvas {
            display: block;
            width: 100%;
            height: 100%;
            max-height: 130px;
           /* background: rgba(0, 0, 0, 0.3);*/
          /* background: transparent; */
            border-radius: 4px;
        }

        #info-footer h3 {
            margin-bottom: 8px;
            color: #667eea;
            font-size: 14px;
        }

        #info-footer p {
            margin-top: 0px;
            font-size: 10px;
            opacity: 0.6;
        }

        #save-area {
            display: none;
        }

        #action-area {
            display: none;
        }

        .distance-value {
            text-align: center;
            margin-top: 0px;
            font-size: 13px;
            font-weight: bold;
        }

        /* ------------------------------------- */
        /* CANVAS AREA */
        /* ------------------------------------- */
        #canvas-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* ------------------------------------- */
        /* TUTACAKLAR (HANDLE'lar) */
        /* ------------------------------------- */
        .vertical-handle,
        .horizontal-handle,
        .new-vertical-handle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: grab;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
            z-index: 20;
        }

        .vertical-handle,
        .new-vertical-handle {
            transform: translateX(-50%);
        }

        .vertical-handle:active,
        .new-vertical-handle:active {
            transform: translateX(-50%) scale(1.1);
        }

        .horizontal-handle {
            transform: translateY(-50%);
        }

        .horizontal-handle:active {
            transform: translateY(-50%) scale(1.1);
        }

        #leftHandle {
            background: #ff4444;
            border: 4px solid #fff;
        }

        #rightHandle {
            background: #4444ff;
            border: 4px solid #fff;
        }

        #topHandle {
            background: #44ff44;
            border: 4px solid #fff;
        }

        #bottomHandle {
            background: #ffaa44;
            border: 4px solid #fff;
        }

        #rHandle {
            background: rgba(255, 102, 171, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.5);
            font-weight: bold;
            color: white;
        }

        #lHandle {
            background: rgba(102, 170, 255, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.5);
            font-weight: bold;
            color: white;
        }

        .input-group.frame-display-group {
            margin-left: auto;
        }

        /* ------------------------------------- */
        /* BUTONLAR */
        /* ------------------------------------- */
        .header-button {
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        #open-camera-button {
            background: linear-gradient(135deg, #c54040 0%, #c54040 100%);
        }

        #calibrate-button {
            background: linear-gradient(135deg, #4444ff 0%, #4444ff 100%);
        }

        #save-button {
            background: linear-gradient(135deg, #fcc300 0%, #fcc300 100%);
            width: 100%;
            padding: 8px 20px;
            font-size: 12px;
            color: #292f35;
        }

        .refresh-btn {
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            white-space: nowrap;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);

            margin: 0 15px 0 25px;
        }

        #patient-name-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
            transition: all 0.2s;
        }

        #patient-name-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #patient-name-input:focus {
           border-color: #fcc300;
           background: rgba(255, 255, 255, 0.15);
        }



        .header-button:active {
            transform: translateY(0);
        }

        .save-button-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            gap: 8px;
            padding: 10px;
        }

        .save-button-container.visible {
            display: flex;
        }

        /* ------------------------------------- */
        /* CAM TOGGLE STYLES */
        /* ------------------------------------- */
        .cam-toggle-container {
            display: none;
            align-items: center;
            gap: 10px;
        }

        .cam-toggle-container.visible {
            display: flex;
        }

        .toggle-button {
            /* Mevcut stillerinizin √ºzerine ekleme veya deƒüi≈üiklikler */

            /* Boyutu 30x30 yap */
            width: 50px;
            height: 50px;

            /* ƒ∞√ß dolguyu kaldƒ±r veya azalt, metni ortalamak i√ßin */
            padding: 0;

            /* K√∂≈üe yuvarlamayƒ± (border-radius) boyutun yarƒ±sƒ±na ayarla */
            border-radius: 50%;
            /* Daire yapmak i√ßin en √∂nemli kural */

            /* Metni butonda ortalamak i√ßin (Eƒüer butonun i√ßinde metin varsa) */
            display: flex;
            align-items: center;
            /* Dikeyde ortala */
            justify-content: center;
            /* Yatayda ortala */

            /* Font boyutu daireye sƒ±ƒüacak ≈üekilde k√º√ß√ºlt√ºlebilir */
            font-size: 14px;

            /* Diƒüer mevcut stiller */
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        /* Mevcut on/off durum stilleri aynƒ± kalabilir */
        .toggle-button.off {
            background: linear-gradient(135deg, #666 0%, #999 100%);
        }

        .toggle-button.on {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .cam-control {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2px 5px;
        }

        .cam-diameter-input {
            width: 45px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
            font-size: 14px;
            outline: none;
        }




        /* PROGRESSIVE TASARIM SE√áƒ∞Cƒ∞ */
        .progressive-selector-container {
            display: none;
            align-items: center;
            gap: 10px;
        }

        .progressive-selector-container.visible {
            display: flex;
        }

        .progressive-select {
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .progressive-select option {
            background: #1a1a1a;
            color: white;
        }

        /* G√ñR√úN√úRL√úK KONTROLLERƒ∞ */
        .cam-controls-container {
            display: none;
        }

        .cam-controls-container.visible {
            display: flex !important;
        }

        .progressive-selector-container {
            display: none;
        }

        .progressive-selector-container.visible {
            display: flex !important;
        }

        .fullscreen-btn {
            background: none;
            border: none;
            color: white;
            font-size: 36px;
            /* üîπ ikon b√ºy√ºt√ºld√º */
            cursor: pointer;
            margin-right: 0px;
            /* üîπ "Ekartman:" ile araya bo≈üluk */
            transition: transform 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:hover {
            transform: scale(1.2);
            color: #00e0ff;
        }
    </style>
</head>

<body>

    <body>
        <div id="main-container">
            <div id="info-header">
                <div class="controls-wrapper">
                    <div class="input-group">
                        <div class="input-label">Ekartman:</div>
                        <div class="value-control">
                            <button class="value-btn" id="ekartman-minus">-</button>
                            <div class="value-display" id="ekartmanValue" style="color: white;">52</div>
                            <button class="value-btn" id="ekartman-plus">+</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-label">K√∂pr√º:</div>
                        <div class="value-control">
                            <button class="value-btn" id="kopru-minus">-</button>
                            <div class="value-display" id="kopruValue" style="color: white;">18</div>
                            <button class="value-btn" id="kopru-plus">+</button>
                        </div>
                    </div>
                    <div id="frameWidth">122 mm</div>

                    <button id="open-camera-button" class="header-button">KAMERA</button>
                    <button id="calibrate-button" class="header-button">KALƒ∞BRE</button>

                    <!-- CAM TOGGLE B√ñL√úM√ú -->
                    <div class="cam-toggle-container" id="camToggleContainer">
                        <button id="cam-toggle-button" class="toggle-button off">CAM</button>
                        <div class="cam-control">
                            <button class="value-btn" id="cam-diameter-minus">-</button>
                            <input type="text" id="cam-diameter-input" class="cam-diameter-input" value="55" readonly>
                            <button class="value-btn" id="cam-diameter-plus">+</button>
                        </div>
                    </div>

                    <!-- PROGRESSIVE TASARIM SE√áƒ∞Cƒ∞ -->
                    <div class="progressive-selector-container" id="progressiveSelector">
                        <select id="progressive-design-select" class="progressive-select">
                            <option value="">Tasarƒ±m Se√ßin</option>
                            <option value="standart">Standart</option>
                            <option value="ultra">Ultra</option>
                            <option value="ultraWide">Ultra Wide</option>
                            <option value="digital">Digital</option>
                        </select>
                    </div>

                    <div class="input-group frame-display-group">
                        <div class="input-label" style="min-width: auto; font-weight: bold; margin-right: 5px;"> </div>
                        <button id="reload-btn" class="header-btn refresh-btn" title="Yenile">YENƒ∞</button>
                        <button id="fullscreen-btn" class="fullscreen-btn" title="Tam Ekran">‚õ∂</button>
                    </div>
                </div>
            </div>

            <div id="info-footer">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; width: 100%; height: 100%;">

                    <!-- SOL: Saƒü G√∂z √ñl√ß√ºmleri -->
                    <div
                        style="display: flex; flex-direction: column; justify-content: center; gap: 8px; font-size: 12px; min-width: 120px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #ff66aa; min-width: 80px; font-size: 14px;">Saƒü PD</strong>
                            <span id="right-pd-result" style="color: #ff66aa; font-size: 14px;font-weight: bold;">0,00 mm</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #ff66aa; min-width: 80px; font-size: 14px;">Montaj Y√ºk.</strong>
                            <span id="right-montage-result" style="color: #ff66aa; font-size: 14px;font-weight: bold;">0,00 mm</span>
                        </div>
                    </div>

                    <!-- ORTA-1: R Grafiƒüi -->
                    <div class="distance-graphic">
                        <canvas id="r-graphic-canvas"></canvas>
                    </div>

                    <!-- ORTA-2: L Grafiƒüi -->
                    <div class="distance-graphic">
                        <canvas id="l-graphic-canvas"></canvas>
                    </div>

                    <!-- SAƒû: Sol G√∂z √ñl√ß√ºmleri -->
                    <div
                        style="display: flex; flex-direction: column; justify-content: center; gap: 8px; font-size: 12px; min-width: 120px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #66aaff; min-width: 80px; font-size: 14px;">Sol PD</strong>
                            <span id="left-pd-result" style="color: #66aaff; font-size: 14px;font-weight: bold;">0,00 mm</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #66aaff; min-width: 80px; font-size: 14px;">Montaj Y√ºk.</strong>
                            <span id="left-montage-result" style="color: #66aaff; font-size: 14px;font-weight: bold;">0,00 mm</span>
                        </div>
                    </div>

                    <!-- EN SAƒû: Hasta Adƒ± ve Kaydet Butonu -->
                    <div class="save-button-container">
                        <input type="text" id="patient-name-input" placeholder="Ad Soyad">
                        <button id="save-button" class="header-button">KAYDET</button>
                    </div>

                </div>
            </div>




            <div id="canvas-area">
                <canvas id="canvas"></canvas>

                <div id="leftHandle" class="vertical-handle">üî¥</div>
                <div id="rightHandle" class="vertical-handle">üîµ</div>
                <div id="topHandle" class="horizontal-handle">üü¢</div>
                <div id="bottomHandle" class="horizontal-handle">üü†</div>
                <div id="rHandle" class="new-vertical-handle">R</div>
                <div id="lHandle" class="new-vertical-handle">L</div>
            </div>

            <!-- Kamera Input (gizli) -->
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
        </div>
    </body>
</body>

</html>
<script>


    // PROGRESSIVE TASARIM NOKTALARI
    const progressiveDesigns = {
        'standart': [
            { x: -0.95, y: -0.1 },
            { x: -0.98, y: 0.05 },
            { x: -0.95, y: 0.3 },
            { x: -0.8, y: 0.6 },
            { x: -0.6, y: 0.8 },
            { x: -0.4, y: 0.7 },
            { x: -0.3, y: 0.4 },
            { x: -0.28, y: 0.1 },
            { x: -0.30, y: -0.2 },
            { x: -0.5, y: -0.35 },
            { x: -0.75, y: -0.25 }
        ],
        'ultra': [
            { x: -0.95, y: -0.05 },
            { x: -0.98, y: 0.1 },
            { x: -0.95, y: 0.4 },
            { x: -0.85, y: 0.65 },
            { x: -0.65, y: 0.85 },
            { x: -0.45, y: 0.75 },
            { x: -0.35, y: 0.5 },
            { x: -0.33, y: 0.2 },
            { x: -0.35, y: -0.1 },
            { x: -0.55, y: -0.3 },
            { x: -0.8, y: -0.2 }
        ],
        'ultraWide': [
            { x: -0.98, y: 0.0 },
            { x: -0.99, y: 0.15 },
            { x: -0.97, y: 0.45 },
            { x: -0.88, y: 0.7 },
            { x: -0.7, y: 0.88 },
            { x: -0.5, y: 0.8 },
            { x: -0.4, y: 0.55 },
            { x: -0.38, y: 0.25 },
            { x: -0.40, y: 0.0 },
            { x: -0.6, y: -0.25 },
            { x: -0.85, y: -0.15 }
        ],
        'digital': [
            { x: -0.92, y: -0.2 },
            { x: -0.95, y: 0.0 },
            { x: -0.92, y: 0.25 },
            { x: -0.78, y: 0.5 },
            { x: -0.58, y: 0.68 },
            { x: -0.38, y: 0.62 },
            { x: -0.28, y: 0.35 },
            { x: -0.26, y: 0.05 },
            { x: -0.28, y: -0.25 },
            { x: -0.48, y: -0.4 },
            { x: -0.72, y: -0.35 }
        ]
    };
    let currentProgressiveDesign = null;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const canvasArea = document.getElementById('canvas-area');
    const infoHeader = document.getElementById('info-header');
    const actionArea = document.getElementById('action-area');

    // Handle elementleri
    const leftHandle = document.getElementById('leftHandle');
    const rightHandle = document.getElementById('rightHandle');
    const topHandle = document.getElementById('topHandle');
    const bottomHandle = document.getElementById('bottomHandle');
    const rHandle = document.getElementById('rHandle');
    const lHandle = document.getElementById('lHandle');

    // √áizgi pozisyonlarƒ±
    let leftLineX = 0;
    let rightLineX = 0;
    let topLineY = 0;
    let bottomLineY = 0;
    let rLineX = 0;
    let rLineY = 0;
    let lLineX = 0;
    let lLineY = 0;

    // S√ºr√ºkleme durumu
    let dragging = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    const HANDLE_SIZE = 50;
    const OFFSET = 20;

    // Deƒüer deƒüi≈ükenleri
    let ekartmanValue = 52;
    let kopruValue = 18;

    // Kalibrasyon deƒüi≈ükenleri
    let isCalibrated = false;
    let calibrationPixels = 0;
    let calibrationMM = 0;

    // Resim deƒüi≈ükenleri
    let loadedImage = null;
    let imageLoaded = false;
    let imageScale = { x: 0, y: 0, width: 0, height: 0 };

    // Buton s√ºrekli basƒ±lƒ± tutma deƒüi≈ükenleri
    let changeInterval;
    let changeTimeout;

    // Global deƒüi≈ükenler
    let solCerceveMerkezX = 0;
    let solCerceveMerkezY = 0;
    let sagCerceveMerkezX = 0;
    let sagCerceveMerkezY = 0;

    // CAM DEƒûƒ∞≈ûKENLERƒ∞
    let camEnabled = false;
    let camDiameterMM = 55;
    let camX = 0;
    let camY = 0;
    let isCamDragging = false;
    let camDragOffsetX = 0;
    let camDragOffsetY = 0;

    // ----------------------------------------------------
    // EKARTMAN VE K√ñPR√ú FONKSƒ∞YONLARI
    // ----------------------------------------------------

    function updateFrameWidth() {
        const totalWidth = ekartmanValue * 2 + kopruValue;
        document.getElementById('frameWidth').textContent = `${totalWidth} mm`;

        if (isCalibrated) {
            calibrationMM = totalWidth;
            calculateMeasurements();
        }

        draw();
    }

    function changeValue(delta, type) {
        if (type === 'ekartman') {
            ekartmanValue = Math.max(40, Math.min(65, ekartmanValue + delta));
            document.getElementById('ekartmanValue').textContent = ekartmanValue;
        } else if (type === 'kopru') {
            kopruValue = Math.max(10, Math.min(25, kopruValue + delta));
            document.getElementById('kopruValue').textContent = kopruValue;
        }
        updateFrameWidth();
    }

    function startChange(delta, type, e) {
        if (e && e.type === 'touchstart') {
            e.preventDefault();
        }

        changeValue(delta, type);

        changeTimeout = setTimeout(() => {
            changeInterval = setInterval(() => {
                changeValue(delta, type);
            }, 100);
        }, 300);

        document.addEventListener('mouseup', endChange);
        document.addEventListener('touchend', endChange);
        document.addEventListener('touchcancel', endChange);
    }

    function endChange() {
        clearTimeout(changeTimeout);
        clearInterval(changeInterval);
        document.removeEventListener('mouseup', endChange);
        document.removeEventListener('touchend', endChange);
        document.removeEventListener('touchcancel', endChange);
    }

    // ----------------------------------------------------
    // KAMERA VE RESƒ∞M Y√ñNETƒ∞Mƒ∞
    // ----------------------------------------------------

    function openCamera() {
        document.getElementById('camera-input').click();
        cameraInput.onchange = () => {
            // Resim se√ßildiƒüinde tam ekranƒ± tekrar a√ß
            if (!document.fullscreenElement) {
                //  document.documentElement.requestFullscreen().catch(err => console.error(err));
            }
        };
    }


    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
                loadedImage = img;
                imageLoaded = true;

                resizeCanvas();
                calculateImageScale();
                draw();

                console.log(`Resim y√ºklendi: ${img.width}x${img.height}`);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    // ----------------------------------------------------
    // RESƒ∞M EN-BOY ORANI HESAPLAMA
    // ----------------------------------------------------

    function calculateImageScale() {
        if (!loadedImage) return;

        const canvasAspect = canvas.width / canvas.height;
        const imageAspect = loadedImage.width / loadedImage.height;

        if (imageAspect > canvasAspect) {
            imageScale.width = canvas.width;
            imageScale.height = canvas.width / imageAspect;
            imageScale.x = 0;
            imageScale.y = (canvas.height - imageScale.height) / 2;
        } else {
            imageScale.height = canvas.height;
            imageScale.width = canvas.height * imageAspect;
            imageScale.x = (canvas.width - imageScale.width) / 2;
            imageScale.y = 0;
        }
    }

    // ----------------------------------------------------
    // R ve L hari√ß diƒüer tutama√ßlarƒ± gizle
    // ----------------------------------------------------
    function hideNonRlHandles() {
        leftHandle.style.display = 'none';
        rightHandle.style.display = 'none';
        topHandle.style.display = 'none';
        bottomHandle.style.display = 'none';
        rHandle.style.display = 'flex';
        lHandle.style.display = 'flex';
    }

    function showAllHandles() {
        leftHandle.style.display = 'flex';
        rightHandle.style.display = 'flex';
        topHandle.style.display = 'flex';
        bottomHandle.style.display = 'flex';
        rHandle.style.display = 'flex';
        lHandle.style.display = 'flex';
    }



    // ----------------------------------------------------
    // CANVAS √úZERƒ∞NE √ñL√á√úM Bƒ∞LGƒ∞LERƒ∞Nƒ∞ YAZMA
    // ----------------------------------------------------
    function drawMeasurementsOnCanvas() {
        if (!isCalibrated) return;

        const pixelToMM = calibrationMM / calibrationPixels;
        const widthPixels = Math.abs(rightLineX - leftLineX) - 3;
        const widthMM = (widthPixels * pixelToMM).toFixed(2);
        const heightPixels = Math.abs(bottomLineY - topLineY) - 3;
        const heightMM = (heightPixels * pixelToMM).toFixed(2);

        const text1 = `Geni≈ülik: ${widthMM} mm`;
        const text2 = `Y√ºkseklik: ${heightMM} mm`;

        ctx.font = "12px Arial";
        const text1Metrics = ctx.measureText(text1);
        const text2Metrics = ctx.measureText(text2);
        const maxTextWidth = Math.max(text1Metrics.width, text2Metrics.width);

        const FONT_HEIGHT = 14;
        const HORIZONTAL_PADDING = 10;
        const VERTICAL_PADDING = 6;
        const LINE_SPACING = 4;

        const rectWidth = maxTextWidth + HORIZONTAL_PADDING * 2;
        const rectHeight = (FONT_HEIGHT + VERTICAL_PADDING) * 2 + LINE_SPACING;

        const rectX = leftLineX + 10;
        const rectY = topLineY - 50;
        const cornerRadius = 5;

        // Siyah zemin
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.beginPath();
        ctx.moveTo(rectX + cornerRadius, rectY);
        ctx.lineTo(rectX + rectWidth - cornerRadius, rectY);
        ctx.arcTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + cornerRadius, cornerRadius);
        ctx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerRadius);
        ctx.arcTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - cornerRadius, rectY + rectHeight, cornerRadius);
        ctx.lineTo(rectX + cornerRadius, rectY + rectHeight);
        ctx.arcTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - cornerRadius, cornerRadius);
        ctx.lineTo(rectX, rectY + cornerRadius);
        ctx.arcTo(rectX, rectY, rectX + cornerRadius, rectY, cornerRadius);
        ctx.closePath();
        ctx.fill();

        // Beyaz yazƒ±lar
        //ctx.fillStyle = "rgba(255, 165, 0, 1.0)"; //turuncu
        ctx.fillStyle = "rgba(255, 255, 0, 1.0)"; // sarƒ±
      
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";

        const text1Y = rectY + VERTICAL_PADDING + FONT_HEIGHT / 2;
        const text2Y = text1Y + FONT_HEIGHT + LINE_SPACING;

        ctx.fillText(text1, rectX + HORIZONTAL_PADDING, text1Y);
        ctx.fillText(text2, rectX + HORIZONTAL_PADDING, text2Y);
    }











    // ----------------------------------------------------
    // KUTULAMA FONKSƒ∞YONU - D√úZELTƒ∞LMƒ∞≈û
    // ----------------------------------------------------
    function kutula() {
        const ekartmanMM = parseInt(document.getElementById('ekartmanValue').textContent);
        const pixelToMM = calibrationMM / calibrationPixels;
        const ekartmanPixels = ekartmanMM / pixelToMM;
        const lineOffset = 1.5;

        const solCerceve = {
            x: leftLineX + lineOffset,
            y: topLineY + lineOffset,
            width: ekartmanPixels,
            height: (bottomLineY - topLineY) - 3
        };

        const sagCerceve = {
            x: rightLineX - lineOffset - ekartmanPixels,
            y: topLineY + lineOffset,
            width: ekartmanPixels,
            height: (bottomLineY - topLineY) - 3
        };

        ctx.strokeStyle = '#FFFF00';
        ctx.lineWidth = 1;
        ctx.setLineDash([]);
        ctx.shadowBlur = 0;
        ctx.shadowColor = '#FFFF00';

        //  ctx.strokeRect(solCerceve.x, solCerceve.y, solCerceve.width, solCerceve.height);
        // ctx.strokeRect(sagCerceve.x, sagCerceve.y, sagCerceve.width, sagCerceve.height);

        // Tek b√ºy√ºk dikd√∂rtgen - soldan saƒüa kadar
        const buyukDikdortgen = {
            x: solCerceve.x,
            y: solCerceve.y,
            width: (sagCerceve.x + sagCerceve.width) - solCerceve.x,
            height: solCerceve.height
        };
        ctx.strokeRect(buyukDikdortgen.x, buyukDikdortgen.y, buyukDikdortgen.width, buyukDikdortgen.height);



        solCerceveMerkezX = solCerceve.x + (solCerceve.width / 2);
        solCerceveMerkezY = solCerceve.y + (solCerceve.height / 2);
        sagCerceveMerkezX = sagCerceve.x + (sagCerceve.width / 2);
        sagCerceveMerkezY = sagCerceve.y + (sagCerceve.height / 2);

        const circleRadius = 7.5;
        const circleColor = '#FFFF00';

        ctx.fillStyle = circleColor;
        ctx.strokeStyle = circleColor;
        ctx.lineWidth = 1;
        ctx.shadowBlur = 0;

        ctx.beginPath();
        ctx.arc(solCerceveMerkezX, solCerceveMerkezY, circleRadius, 0, Math.PI * 2);
        ctx.fill();

        ctx.beginPath();
        ctx.arc(sagCerceveMerkezX, sagCerceveMerkezY, circleRadius, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = '#FFFF00';
        ctx.lineWidth = 1;
        ctx.setLineDash([]);
        ctx.shadowBlur = 0;

        ctx.beginPath();
        ctx.moveTo(solCerceve.x, solCerceveMerkezY);
        ctx.lineTo(solCerceve.x + solCerceve.width, solCerceveMerkezY);
        ctx.moveTo(solCerceveMerkezX, solCerceve.y);
        ctx.lineTo(solCerceveMerkezX, solCerceve.y + solCerceve.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(sagCerceve.x, sagCerceveMerkezY);
        ctx.lineTo(sagCerceve.x + sagCerceve.width, sagCerceveMerkezY);
        ctx.moveTo(sagCerceveMerkezX, sagCerceve.y);
        ctx.lineTo(sagCerceveMerkezX, sagCerceve.y + sagCerceve.height);
        ctx.stroke();

        ctx.shadowBlur = 0;

        console.log(`√áer√ßeveler √ßizildi: Sol(${solCerceve.x.toFixed(1)}, ${solCerceve.y.toFixed(1)}, ${solCerceve.width.toFixed(1)}, ${solCerceve.height.toFixed(1)}) Saƒü(${sagCerceve.x.toFixed(1)}, ${sagCerceve.y.toFixed(1)}, ${sagCerceve.width.toFixed(1)}, ${sagCerceve.height.toFixed(1)})`);
    }

    // ----------------------------------------------------
    // KALƒ∞BRASYON FONKSƒ∞YONU - D√úZELTƒ∞LMƒ∞≈û
    // ----------------------------------------------------

    function calibrate() {
        if (!imageLoaded) {
            alert('‚ö†Ô∏è L√ºtfen √∂nce fotoƒüraf y√ºkleyin!');
            return;
        }

        calibrationPixels = Math.abs(rightLineX - leftLineX) - 3;
        calibrationMM = ekartmanValue * 2 + kopruValue;
        isCalibrated = true;

        const calibrateBtn = document.getElementById('calibrate-button');
        calibrateBtn.textContent = 'KALƒ∞BRE ‚úì';
        calibrateBtn.style.background = 'linear-gradient(135deg, #1a9147 0%, #1a9147 100%)';

        // KAYDET B√ñL√úM√úN√ú G√ñSTER
        document.querySelector('.save-button-container').classList.add('visible');

        // CAM TOGGLE B√ñL√úM√úN√ú G√ñSTER
        document.getElementById('camToggleContainer').classList.add('visible');

        // PROGRESSIVE SELECTOR'ƒ± G√ñSTER - BU SATIR EKLENDƒ∞
        document.getElementById('progressiveSelector').classList.add('visible');

        // Varsayƒ±lan progressive tasarƒ±mƒ± ayarla
        if (!currentProgressiveDesign) {
            currentProgressiveDesign = 'standart';
            const selectElement = document.getElementById('progressive-design-select');
            if (selectElement) {
                selectElement.value = 'standart';
            }
        }

        // √ñNEMLƒ∞: √ñnce kutula fonksiyonunu √ßaƒüƒ±r ki cerceve merkezleri hesaplansƒ±n
        hideNonRlHandles();
        kutula();
        calculateMeasurements();

        // CAM'I SOL √áER√áEVE MERKEZƒ∞NE YERLE≈ûTƒ∞R
        camX = solCerceveMerkezX;
        camY = solCerceveMerkezY;

        console.log(`Cam SOL merkezine yerle≈ütirildi: ${camX.toFixed(1)}, ${camY.toFixed(1)}`);
        console.log(`Progressive tasarƒ±m: ${currentProgressiveDesign}`);

        draw();
        console.log(`Kalibrasyon yapƒ±ldƒ±: ${calibrationPixels.toFixed(2)}px = ${calibrationMM}mm`);
    }

    // ----------------------------------------------------
    // CAM FONKSƒ∞YONLARI
    // ----------------------------------------------------

    // -----------------------------------------------------------------------**** cam se√ßili ise diƒüerleni gizleMEZ  ***------toggleCam() ve draw()-----------------------------------------------------
    function toggleCam2() {
        camEnabled = !camEnabled;
        const camButton = document.getElementById('cam-toggle-button');

        if (camEnabled) {
            camButton.classList.remove('off');
            camButton.classList.add('on');
            camButton.textContent = 'CAM ‚úì';
        } else {
            camButton.classList.remove('on');
            camButton.classList.add('off');
            camButton.textContent = 'CAM';
        }

        draw(); // √áizimleri yenile
    }

    function toggleCam() {
        camEnabled = !camEnabled;
        const camButton = document.getElementById('cam-toggle-button');

        if (camEnabled) {
            camButton.classList.remove('off');
            camButton.classList.add('on');
            camButton.textContent = 'CAM ‚úì';

            // R ve L TUTA√áLARINI Gƒ∞ZLE
            rHandle.style.display = 'none';
            lHandle.style.display = 'none';

        } else {
            camButton.classList.remove('on');
            camButton.classList.add('off');
            camButton.textContent = 'CAM';

            // R ve L TUTA√áLARINI GERƒ∞ G√ñSTER
            rHandle.style.display = 'flex';
            lHandle.style.display = 'flex';
        }

        draw(); // √áizimleri yenile
    }

    function changeCamDiameter(delta) {
        camDiameterMM = Math.max(20, Math.min(100, camDiameterMM + delta));
        document.getElementById('cam-diameter-input').value = camDiameterMM;
        draw();
    }

    // PROGRESSIVE ≈ûEKƒ∞L √áƒ∞Zƒ∞M FONKSƒ∞YONU
    function drawProgressiveShape(points, radiusPixels, centerX, centerY) {
        if (points.length < 3) return;

        ctx.save();

        // Cam √ßer√ßevesi i√ßinde kal
        ctx.beginPath();
        ctx.arc(centerX, centerY, radiusPixels, 0, Math.PI * 2);
        ctx.clip();

        // Noktalarƒ± ger√ßek koordinatlara √ßevir
        const realPoints = points.map(p => ({
            x: centerX + radiusPixels * p.x,
            y: centerY + radiusPixels * p.y
        }));

        // ≈ûekli √ßiz
        ctx.beginPath();
        ctx.moveTo(realPoints[0].x, realPoints[0].y);

        // Yumu≈üak eƒüriler
        for (let i = 0; i < realPoints.length - 1; i++) {
            const current = realPoints[i];
            const next = realPoints[i + 1];
            const midX = (current.x + next.x) / 2;
            const midY = (current.y + next.y) / 2;
            ctx.quadraticCurveTo(current.x, current.y, midX, midY);
        }

        // Son nokta ile ilk nokta arasƒ±nƒ± baƒüla
        const last = realPoints[realPoints.length - 1];
        const first = realPoints[0];
        const midX = (last.x + first.x) / 2;
        const midY = (last.y + first.y) / 2;
        ctx.quadraticCurveTo(last.x, last.y, midX, midY);
        ctx.quadraticCurveTo(first.x, first.y, first.x, first.y);
        ctx.closePath();

        // Gri renk ile boya
        ctx.fillStyle = 'rgba(180, 180, 180, 0.6)';
        ctx.fill();

        ctx.restore();
    }

    // MIRROR FONKSƒ∞YONU
    function mirrorPoints(points) {
        return points.map(p => ({
            x: -p.x,
            y: p.y
        }));
    }





    function applyGlassesEffect() {
        if (!camEnabled || !isCalibrated || !loadedImage) return;

        // currentProgressiveDesign kontrol√º ekle
        if (!currentProgressiveDesign) {
            console.warn('No progressive design selected');
            return;
        }

        const selectedDesign = progressiveDesigns[currentProgressiveDesign];

        // Se√ßili tasarƒ±mƒ±n varlƒ±ƒüƒ±nƒ± kontrol et
        if (!selectedDesign || !Array.isArray(selectedDesign)) {
            console.warn('Invalid progressive design:', currentProgressiveDesign);
            return;
        }

        const pixelToMM = calibrationMM / calibrationPixels;
        const radiusPixels = (camDiameterMM / 2) / pixelToMM;

        // Orijinal resmi √ßiz
        ctx.drawImage(
            loadedImage,
            imageScale.x,
            imageScale.y,
            imageScale.width,
            imageScale.height
        );

        // Sol damla (resimde saƒü g√∂z)
        drawProgressiveShape(selectedDesign, radiusPixels, camX, camY);

        // Saƒü damla (mirror)
        const rightDesign = mirrorPoints(selectedDesign);
        drawProgressiveShape(rightDesign, radiusPixels, camX, camY);

        // Cam √ßer√ßevesini √ßiz
        drawGlassFrame(camX, camY, radiusPixels);
    }









    function drawGlassFrame(x, y, radiusPixels) {
        // Metal √ßer√ßeve efekti
        ctx.strokeStyle = '#8B8B8B';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.arc(x, y, radiusPixels, 0, Math.PI * 2);
        ctx.stroke();

        // ƒ∞√ß kenarda ƒ±≈üƒ±k yansƒ±masƒ±
        ctx.strokeStyle = '#B8B8B8';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, radiusPixels - 2, 0, Math.PI * 2);
        ctx.stroke();

        // Dƒ±≈ü kenarda g√∂lge
        ctx.strokeStyle = '#696969';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, radiusPixels + 2, 0, Math.PI * 2);
        ctx.stroke();

        // Progressive lens i≈üaretleri
        ctx.strokeStyle = 'rgb(249, 253, 0)';
        ctx.lineWidth = 2.5;

        // √ústte yarƒ±m daire
        ctx.beginPath();
        ctx.arc(x, y - radiusPixels * 0.2, radiusPixels * 0.15, 0, Math.PI, true);
        ctx.stroke();

        // Ortada yatay √ßizgi ve artƒ± i≈üareti
        const lineLength = radiusPixels * 0.5;
        ctx.beginPath();
        ctx.moveTo(x - lineLength, y);
        ctx.lineTo(x + lineLength, y);
        ctx.stroke();

        // Artƒ± i≈üareti dikey √ßizgi
        ctx.beginPath();
        ctx.moveTo(x, y - radiusPixels * 0.1);
        ctx.lineTo(x, y + radiusPixels * 0.1);
        ctx.stroke();

        // Sol daire
        ctx.beginPath();
        ctx.arc(x - lineLength - radiusPixels * 0.08, y, radiusPixels * 0.06, 0, Math.PI * 2);
        ctx.stroke();

        // Saƒü daire
        ctx.beginPath();
        ctx.arc(x + lineLength + radiusPixels * 0.08, y, radiusPixels * 0.06, 0, Math.PI * 2);
        ctx.stroke();

        // Altta b√ºy√ºk daire
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(x + 15, y + radiusPixels * 0.40, radiusPixels * 0.10, 0, Math.PI * 2);
        ctx.stroke();
    }

    function startCamDrag(e) {
        if (!camEnabled) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Canvas koordinatlarƒ±na d√∂n√º≈üt√ºr
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = x * scaleX;
        const canvasY = y * scaleY;

        const pixelToMM = calibrationMM / calibrationPixels;
        const radiusPixels = (camDiameterMM / 2) / pixelToMM;

        // Cam i√ßinde mi kontrol et
        const dist = Math.sqrt(Math.pow(canvasX - camX, 2) + Math.pow(canvasY - camY, 2));
        if (dist <= radiusPixels) {
            isCamDragging = true;
            camDragOffsetX = canvasX - camX;
            camDragOffsetY = canvasY - camY;
        }
    }

    function dragCam(e) {
        if (!isCamDragging || !camEnabled) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Canvas koordinatlarƒ±na d√∂n√º≈üt√ºr
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = x * scaleX;
        const canvasY = y * scaleY;

        camX = canvasX - camDragOffsetX;
        camY = canvasY - camDragOffsetY;

        draw();
    }

    function endCamDrag() {
        isCamDragging = false;
    }

    // ----------------------------------------------------
    // √ñL√á√úM HESAPLAMA FONKSƒ∞YONLARI - D√úZELTƒ∞LMƒ∞≈û
    // ----------------------------------------------------
    // Grafik √ßizim fonksiyonu - D√úZELTƒ∞LMƒ∞≈û
    function drawDistanceGraphic(canvasId, dx, dy, dxMM, dyMM, color) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = canvas.offsetHeight;

        ctx.clearRect(0, 0, width, height);

        // Merkez noktasƒ±
        const centerX = width / 2;
        const centerY = height / 2;
        const pointRadius = 2;

        // √ñNEMLƒ∞: Piksel deƒüerlerini kullan, mm deƒüil!
        // dx ve dy zaten piksel cinsinden geliyor

        // √ñl√ßekleme fakt√∂r√º - grafik alanƒ±na sƒ±ƒüdƒ±rmak i√ßin
        const maxPixelDistance = Math.max(Math.abs(dx), Math.abs(dy), 1);

        // G√ºvenli √∂l√ßekleme - grafik sƒ±nƒ±rlarƒ±nƒ± a≈ümasƒ±n
        const maxGraphWidth = width / 2 - 40;
        const maxGraphHeight = height / 2 - 20;

        let scale;
        if (maxPixelDistance > 0) {
            const scaleX = maxGraphWidth / Math.abs(dx || 1);
            const scaleY = maxGraphHeight / Math.abs(dy || 1);
            scale = Math.min(scaleX, scaleY, 1); // Maksimum 1 (ger√ßek boyut)

            // Eƒüer √ßok k√º√ß√ºkse biraz b√ºy√ºt
            if (scale * maxPixelDistance < 30) {
                scale = 30 / maxPixelDistance;
            }
        } else {
            scale = 1;
        }

        // Hedef nokta - √ñL√áEKLENMƒ∞≈û piksel deƒüerleri
        const targetX = centerX + (dx * scale);
        const targetY = centerY - (dy * scale); // Y eksenini ters √ßevir

        // Ok √ßizimi - X ekseni
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(targetX, centerY);
        ctx.stroke();

        // X ok ba≈üƒ±
        drawArrowHeadSmall(ctx, targetX, centerY, 8, dx > 0 ? 0 : 180, color);

        // X mesafe yazƒ±sƒ± - GER√áEK MM DEƒûER
        ctx.fillStyle = color;
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const xTextY = dy > 0 ? centerY + 18 : centerY - 18;
        ctx.fillText(`${dxMM} mm`, (centerX + targetX) / 2, xTextY);

        // Ok √ßizimi - Y ekseni
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX, targetY);
        ctx.stroke();

        // Y ok ba≈üƒ±
        drawArrowHeadSmall(ctx, centerX, targetY, 8, dy > 0 ? 270 : 90, color);

        // Y mesafe yazƒ±sƒ± - GER√áEK MM DEƒûER
        const yTextX = dx > 0 ? centerX - 36 : centerX + 36;
        ctx.fillText(`${dyMM} mm`, yTextX, (centerY + targetY) / 2);

        // Merkez noktasƒ± (√ßer√ßeve merkezi) - ye≈üil
        ctx.fillStyle = '#00ff00';
        ctx.shadowBlur = 5;
        ctx.shadowColor = '#00ff00';
        ctx.beginPath();
        ctx.arc(centerX, centerY, pointRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Hedef nokta (tutama√ß) - renkli
        ctx.fillStyle = color;
        ctx.shadowBlur = 5;
        ctx.shadowColor = color;
        ctx.beginPath();
        ctx.arc(targetX, targetY, pointRadius - 1, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }


    // K√º√ß√ºk ok ba≈üƒ± √ßizimi - G√úNCELLENMƒ∞≈û
    function drawArrowHeadSmall(ctx, x, y, size, angleDeg, color) {
        const angleRad = angleDeg * Math.PI / 180;
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angleRad);
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-size, -size / 2);
        ctx.moveTo(0, 0);
        ctx.lineTo(-size, size / 2);
        ctx.stroke();
        ctx.restore();
    }

    // calculateMeasurements fonksiyonunu g√ºncelle
    function calculateMeasurements() {
        if (!isCalibrated) {
            document.getElementById('right-pd-result').textContent = '-- --';
            document.getElementById('left-pd-result').textContent = '-- --';
            document.getElementById('right-montage-result').textContent = '-- --';
            document.getElementById('left-montage-result').textContent = '-- --';

            // Grafikleri temizle
            const rCanvas = document.getElementById('r-graphic-canvas');
            const lCanvas = document.getElementById('l-graphic-canvas');
            if (rCanvas) rCanvas.getContext('2d').clearRect(0, 0, rCanvas.width, rCanvas.height);
            if (lCanvas) lCanvas.getContext('2d').clearRect(0, 0, lCanvas.width, lCanvas.height);

            return;
        }

        const pixelToMM = calibrationMM / calibrationPixels;

        const centerX = (leftLineX + rightLineX) / 2;

        const rightPDPixels = Math.abs(rLineX - centerX);
        const rightPDMM = rightPDPixels * pixelToMM;

        const leftPDPixels = Math.abs(lLineX - centerX);
        const leftPDMM = leftPDPixels * pixelToMM;

        // Montaj y√ºkseklikleri hesapla
        const lineHeight = 100;
        const rCrossTop = rLineY - lineHeight - 20;
        const lCrossTop = lLineY - lineHeight - 20;

        const rightMontageHeightPixels = Math.abs(bottomLineY - rCrossTop);
        const rightMontageHeightMM = rightMontageHeightPixels * pixelToMM;

        const leftMontageHeightPixels = Math.abs(bottomLineY - lCrossTop);
        const leftMontageHeightMM = leftMontageHeightPixels * pixelToMM;

        // Footer'a yazdƒ±r
        document.getElementById('right-pd-result').textContent = rightPDMM.toFixed(2).replace('.', ',') + ' mm';
        document.getElementById('left-pd-result').textContent = leftPDMM.toFixed(2).replace('.', ',') + ' mm';
        document.getElementById('right-montage-result').textContent = rightMontageHeightMM.toFixed(2).replace('.', ',') + ' mm';
        document.getElementById('left-montage-result').textContent = leftMontageHeightMM.toFixed(2).replace('.', ',') + ' mm';

        // R ve L tutama√ßlarƒ±nƒ±n merkezden uzaklƒ±ƒüƒ±
        const rDX = rLineX - solCerceveMerkezX;
        const rDY = solCerceveMerkezY - rCrossTop;
        const rDistanceXMM = (Math.abs(rDX) * pixelToMM).toFixed(2);
        const rDistanceYMM = (Math.abs(rDY) * pixelToMM).toFixed(2);

        const lDX = lLineX - sagCerceveMerkezX;
        const lDY = sagCerceveMerkezY - lCrossTop;
        const lDistanceXMM = (Math.abs(lDX) * pixelToMM).toFixed(2);
        const lDistanceYMM = (Math.abs(lDY) * pixelToMM).toFixed(2);

        // Grafikleri √ßiz
        drawDistanceGraphic('r-graphic-canvas', rDX, rDY, rDistanceXMM, rDistanceYMM, '#ff66aa');
        drawDistanceGraphic('l-graphic-canvas', lDX, lDY, lDistanceXMM, lDistanceYMM, '#66aaff');
    }


    // ----------------------------------------------------
    // CANVAS BOYUTLANDIRMA VE HANDLE FONKSƒ∞YONLARI
    // ----------------------------------------------------

     function resizeCanvas() {
        // ============================================
        // FOOTER BOYUTLANDIRMA
        // ============================================
        const footerHeight = 150;
        const footer = document.getElementById('info-footer');
        footer.style.height = footerHeight + 'px';
        footer.style.minHeight = footerHeight + 'px';
        footer.style.maxHeight = footerHeight + 'px';

        // ============================================
        // CANVAS ALAN BOYUTLANDIRMA
        // ============================================
        canvasArea.style.height = window.innerHeight + 'px';
        canvasArea.style.maxHeight = window.innerHeight + 'px';
        canvasArea.style.minHeight = window.innerHeight + 'px';

        const rect = canvasArea.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;

        // ============================================
        // HANDLE BA≈ûLANGI√á POZƒ∞SYONLARI
        // ============================================
        if (leftLineX === 0) {

            // ----------------------------------------
            // YATAY POZƒ∞SYONLAR (X EKSENƒ∞)
            // ----------------------------------------
            leftLineX = canvas.width * 0.25;   // Kƒ±rmƒ±zƒ± dikey √ßizgi
            rightLineX = canvas.width * 0.75;  // Mavi dikey √ßizgi
            rLineX = canvas.width * 0.4;       // R tutamacƒ±
            lLineX = canvas.width * 0.6;       // L tutamacƒ±

            // ----------------------------------------
            // Dƒ∞KEY POZƒ∞SYONLAR (Y EKSENƒ∞)
            // ----------------------------------------

            const headerOffset = 60;
            const extraDownOffset = 180;
            const footerOffset = 200;

            const usableTop = headerOffset + extraDownOffset;
            const usableBottom = canvas.height - footerOffset;
            const usableHeight = usableBottom - usableTop;

            // Ye≈üil ve Turuncu yatay √ßizgiler
            topLineY = usableTop + (usableHeight * 0.2);
            bottomLineY = usableTop + (usableHeight * 0.8);

            // R ve L tutama√ßlarƒ±
            rLineY = usableTop + (usableHeight * 0.7); // R tutamacƒ± 0.5 daha yukarƒ±da
            lLineY = usableTop + (usableHeight * 0.7);

            updateFrameWidth();
        }

        if (imageLoaded) {
            calculateImageScale();
        }

        updateHandles();
        draw();
        calculateMeasurements();
    }


    // Sayfa y√ºklendiƒüinde
    window.addEventListener('load', resizeCanvas);

    window.addEventListener('resize', resizeCanvas);

    function updateHandles() {
        const canvasActualHeight = canvas.height;
        const canvasActualWidth = canvas.width;

        // ============================================
        // Dƒ∞KEY TUTAMA√áLAR (KIRMIZI üî¥ VE MAVƒ∞ üîµ)
        // ============================================
        // Bu tutama√ßlar footer yakƒ±nƒ±nda durur

        const footerHeight = 150;              // Footer y√ºksekliƒüi
        const extraSpaceFromFooter = 20;       // Footer'dan bo≈üluk
        const verticalHandleUpOffset = 0;      // ‚Üë Bu deƒüeri ARTIRIRSAN tutama√ßlar YUKARI √ßƒ±kar (100, 150, vs.)
        // ‚Üì Bu deƒüeri AZALTIRSAN tutama√ßlar A≈ûAƒûI iner (0, -50, -100, vs.)

        // Tutama√ßlarƒ±n Y pozisyonu
        const verticalHandleTopY = canvasActualHeight - footerHeight - HANDLE_SIZE - OFFSET - extraSpaceFromFooter - verticalHandleUpOffset;

        leftHandle.style.left = leftLineX + 'px';
        leftHandle.style.top = verticalHandleTopY + 'px';

        rightHandle.style.left = rightLineX + 'px';
        rightHandle.style.top = verticalHandleTopY + 'px';

        // ============================================
        // YATAY TUTAMA√áLAR (YE≈ûƒ∞L üü¢ VE TURUNCU üü†)
        // ============================================
        // Bu tutama√ßlar saƒü kenarda durur

        const horizontalHandleLeftX = canvasActualWidth - HANDLE_SIZE - OFFSET;

        topHandle.style.top = topLineY + 'px';
        topHandle.style.left = horizontalHandleLeftX + 'px';

        bottomHandle.style.top = bottomLineY + 'px';
        bottomHandle.style.left = horizontalHandleLeftX + 'px';

        // ============================================
        // R ve L TUTAMA√áLARI
        // ============================================
        rHandle.style.left = rLineX + 'px';
        rHandle.style.top = rLineY + 'px';

        lHandle.style.left = lLineX + 'px';
        lHandle.style.top = lLineY + 'px';

        // ----------------------------------------
        // √ñZET:
        // ----------------------------------------
        // üî¥üîµ Kƒ±rmƒ±zƒ± ve Mavi tutama√ßlarƒ±:
        //   A≈ûAƒûI ‚Üí verticalHandleUpOffset = 0 veya negatif (-50, -100)
        //   YUKARI ‚Üí verticalHandleUpOffset = 100, 150, 200
        //
        // üü¢üü† Ye≈üil ve Turuncu √ßizgilerini (tutama√ßlarƒ± deƒüil):
        //   resizeCanvas() i√ßinde topLineY ve bottomLineY'yi deƒüi≈ütir
        //
        // R L tutama√ßlarƒ±nƒ±:
        //   resizeCanvas() i√ßinde rLineY ve lLineY'yi deƒüi≈ütir
        // ----------------------------------------

        /*
        √ñnemli Not:    
        updateHandles() fonksiyonu tutama√ßlarƒ±n g√∂rsel pozisyonunu ayarlar
        verticalHandleUpOffset parametresi sadece üî¥ Kƒ±rmƒ±zƒ± ve üîµ Mavi tutama√ßlarƒ± etkiler
        Ye≈üil ve Turuncu tutama√ßlar kendi √ßizgilerine (topLineY, bottomLineY) baƒülƒ±dƒ±r

        Hƒ±zlƒ± Test:
        const verticalHandleUpOffset = -100;  // Kƒ±rmƒ±zƒ± ve Mavi 100px daha a≈üaƒüƒ±
        */
    }



    // ----------------------------------------------------
    // CETVEL √áƒ∞Zƒ∞M FONKSƒ∞YONU
    // ----------------------------------------------------

    function drawRuler2piksel(x1, y1, x2, y2) {
        const offset = 40; // cetveli yukarƒ± kaydƒ±r
        const dx = x2 - x1;
        const dy = y2 - y1;
        const angle = Math.atan2(dy, dx);
        const uzunlukPX = Math.sqrt(dx * dx + dy * dy);

        // Piksel olarak cetvel √ßiz
        ctx.save();
        ctx.translate(x1, y1);
        ctx.rotate(angle);

        const tickHeightSmall = 10;
        const tickHeightMedium = 15;
        const tickHeightLarge = 25;

        for (let i = 0; i <= uzunlukPX; i += 10) { // her 10 pikselde bir √ßizgi
            let tickHeight = tickHeightSmall;
            if (i % 50 === 0) tickHeight = tickHeightLarge;
            else if (i % 20 === 0) tickHeight = tickHeightMedium;

            ctx.beginPath();
            ctx.moveTo(i, 0);
            ctx.lineTo(i, tickHeight);
            ctx.lineWidth = 1;
            ctx.strokeStyle = "rgba(255,255,255,0.8)";
            ctx.stroke();
        }

        // Toplam uzunluƒüu yaz (piksel cinsinden)
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "bottom";
        ctx.fillText(`${Math.round(uzunlukPX)} px`, uzunlukPX / 2, -8);

        ctx.restore();
    }



    function drawRuler(x1, y1, x2, y2) {
        const dx = x2 - x1;
        const dy = y2 - y1;
        const angle = Math.atan2(dy, dx);
        const lengthPX = Math.sqrt(dx * dx + dy * dy);

        // DOƒûRU √∂l√ß√ºm - kalibrasyon kullan (Bu deƒüi≈ükenlerin (isCalibrated, calibrationPixels, calibrationMM) dƒ±≈üarƒ±dan tanƒ±mlƒ± olduƒüu varsayƒ±lmƒ±≈ütƒ±r)
        let lengthMM = isCalibrated ? (lengthPX / calibrationPixels) * calibrationMM : 0;

        ctx.save();
        ctx.translate(x1, y1);
        ctx.rotate(angle);

        // Cetvel √ßizgisi - √ñL√á√úLEN MESAFE KADAR √áƒ∞Z
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(lengthPX, 0);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "rgba(255,255,255,0.9)";
        ctx.stroke();

        // MM bazlƒ± cetvel √ßizimi - Pƒ∞KSEL/MM ORANINI DOƒûRU HESAPLA
        // lengthMM sƒ±fƒ±r ise (kalibre deƒüilse) b√∂lme hatasƒ±nƒ± √∂nlemek i√ßin kontrol ekleyelim
        const pxPerMM = lengthMM > 0 ? lengthPX / lengthMM : 0;

        // Cetvelin toplam mm uzunluƒüu kadar √ßiz (65.25 mm ise 65.25 mm'lik cetvel)
        const totalMM = Math.ceil(lengthMM);

        // totalMM'den b√ºy√ºk bir deƒüer i√ßin √ßizim yapmaya gerek yok, lengthPX yeterli
        // const rulerLengthPX = totalMM * pxPerMM; 

        for (let mm = 0; mm <= totalMM; mm += 1) { // her 1 mm'de bir √ßizgi
            const currentPX = mm * pxPerMM;

            // Eƒüer mevcut piksel √∂l√ß√ºlen piksel uzunluƒüunu a≈üarsa d√∂ng√ºy√º kƒ±r
            if (currentPX > lengthPX) break;

            // √áizgi y√ºksekliƒüini belirle
            let tickHeight = 10; // kƒ±sa √ßizgi
            if (mm % 10 === 0) tickHeight = 25; // 10 mm'de bir uzun √ßizgi
            else if (mm % 5 === 0) tickHeight = 15; // 5 mm'de bir orta √ßizgi

            ctx.beginPath();
            ctx.moveTo(currentPX, 0);
            ctx.lineTo(currentPX, tickHeight);
            ctx.lineWidth = 1;
            ctx.strokeStyle = "rgba(255,255,255,0.8)";
            ctx.stroke();

            // Sayƒ± etiketleri (10 mm'de bir)
            if (mm % 10 === 0 && mm !== 0) {
                ctx.fillStyle = "rgba(255,255,255,0.9)";
                ctx.font = "bold 12px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "top";
                ctx.fillText(mm.toString(), currentPX, 28);
            }
        }

        // --- YARI SAYDAM Sƒ∞YAH ZEMƒ∞N √úZERƒ∞NE √ñL√á√úM DEƒûERƒ∞ YAZIMI ---
        if (lengthMM > 0) {
            const textToDisplay = `${lengthMM.toFixed(2)} mm`;

            ctx.font = "bold 14px Arial";
            const textMetrics = ctx.measureText(textToDisplay);
            const textWidth = textMetrics.width;

            const FONT_HEIGHT = 14;
            const HORIZONTAL_PADDING = 8;
            const VERTICAL_PADDING = 4;
            const OFFSET_FROM_RULER = 8;

            const rectWidth = textWidth + HORIZONTAL_PADDING * 2;
            const rectHeight = FONT_HEIGHT + VERTICAL_PADDING * 2;

            const rectX = lengthPX / 2 - rectWidth / 2;
            const rectY = -OFFSET_FROM_RULER - rectHeight;
            const textY = rectY + VERTICAL_PADDING + FONT_HEIGHT / 2;

            // Yeni Deƒüer: K√∂≈üe Yuvarlatma Yarƒ±√ßapƒ± (Radius)
            const cornerRadius = 5; // Ka√ß piksel yuvarlatƒ±lacaƒüƒ±nƒ± belirler

            // 1. Yuvarlatƒ±lmƒ±≈ü Siyah Zemin √áizimi (Path Kullanarak)
            ctx.fillStyle = "rgba(0, 0, 0, 0.7)"; // Yarƒ± saydam siyah

            ctx.beginPath();

            // Yuvarlatƒ±lmƒ±≈ü Dikd√∂rtgen √áizimi:

            // √úst-Sol k√∂≈üeden ba≈üla
            ctx.moveTo(rectX + cornerRadius, rectY);

            // √úst Kenar
            ctx.lineTo(rectX + rectWidth - cornerRadius, rectY);
            // √úst-Saƒü k√∂≈üe (yay)
            ctx.arcTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + cornerRadius, cornerRadius);

            // Saƒü Kenar
            ctx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerRadius);
            // Alt-Saƒü k√∂≈üe (yay)
            ctx.arcTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - cornerRadius, rectY + rectHeight, cornerRadius);

            // Alt Kenar
            ctx.lineTo(rectX + cornerRadius, rectY + rectHeight);
            // Alt-Sol k√∂≈üe (yay)
            ctx.arcTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - cornerRadius, cornerRadius);

            // Sol Kenar
            ctx.lineTo(rectX, rectY + cornerRadius);
            // √úst-Sol k√∂≈üe (yay)
            ctx.arcTo(rectX, rectY, rectX + cornerRadius, rectY, cornerRadius);

            ctx.closePath();
            ctx.fill(); // Yolu siyah renkle doldur

            // 2. Beyaz Metin Yazƒ±mƒ±
            ctx.fillStyle = "rgba(255, 255, 255, 1.0)"; // Beyaz metin
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            ctx.fillText(textToDisplay, lengthPX / 2, textY);
        }
        // --- Bƒ∞Tƒ∞≈û ---

        ctx.restore();

        return lengthMM;
    }



    // ----------------------------------------------------
    // OK FONKSƒ∞YONLARI
    // ----------------------------------------------------

    function drawArrowHead(ctx, x, y, size, angleDeg, color) {
        const angleRad = angleDeg * Math.PI / 180;
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angleRad);
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-size, -size / 2);
        ctx.moveTo(0, 0);
        ctx.lineTo(-size, size / 2);
        ctx.stroke();
        ctx.restore();
    }

    function drawDistanceIndicator(pointX, pointY, refX, refY, color, label, pixelToMM, yOffset = 0) {
        const arrowSize = 8;
        const dx = refX - pointX;
        const dy = refY - pointY;
        const absDx = Math.abs(dx);
        const absDy = Math.abs(dy);

        // Piksel'i mm'ye √ßevir (ORƒ∞Jƒ∞NAL koordinatlarla hesapla)
        const dxMM = (absDx * pixelToMM).toFixed(1);
        const dyMM = (absDy * pixelToMM).toFixed(1);

        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.font = '12px Arial';
        ctx.fillStyle = color;
        ctx.textAlign = 'center';

        // √áizim i√ßin Y koordinatƒ±nƒ± kaydƒ±r
        const drawPointY = pointY - yOffset;

        // --- X ekseni --- (deƒüi≈ümedi)
        const endX = pointX - dx;
        ctx.beginPath();
        ctx.moveTo(pointX, drawPointY); // drawPointY kullan
        ctx.lineTo(endX, drawPointY);   // drawPointY kullan
        ctx.stroke();
        const arrowAngleX = (refX > pointX) ? 180 : 0;
        drawArrowHead(ctx, endX, drawPointY, arrowSize, arrowAngleX, color); // drawPointY kullan
        const textOffsetX = (refX > pointX) ? -15 : 15;
        ctx.fillText(`${dxMM} mm`, endX + textOffsetX, drawPointY - 5); // drawPointY kullan

        // --- Y ekseni --- (kaydƒ±rƒ±lmƒ±≈ü)
        const endY = drawPointY - dy; // drawPointY kullan
        ctx.beginPath();
        ctx.moveTo(pointX, drawPointY); // drawPointY kullan
        ctx.lineTo(pointX, endY);       // drawPointY kullan
        ctx.stroke();
        const arrowAngleY = (refY > pointY) ? 270 : 90; // √ñl√ß√ºm i√ßin orijinal pointY
        drawArrowHead(ctx, pointX, endY, arrowSize, arrowAngleY, color);
        const textOffsetY = (refY > pointY) ? -10 : 20;
        ctx.fillText(`${dyMM} mm`, pointX, endY + textOffsetY);
    }

    // -----------------------------------------------------------------------**** cam se√ßili ise diƒüerleni gizleMEZ  ***------toggleCam() ve draw()-----------------------------------------------------
    function draw2() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (imageLoaded && loadedImage) {
            ctx.drawImage(
                loadedImage,
                imageScale.x,
                imageScale.y,
                imageScale.width,
                imageScale.height
            );
        }

        if (!isCalibrated) {
            // Referans √ßizgileri
            ctx.strokeStyle = '#ff4444'; ctx.lineWidth = 3; ctx.shadowBlur = 20; ctx.shadowColor = '#ff4444';
            ctx.beginPath(); ctx.moveTo(leftLineX, 0); ctx.lineTo(leftLineX, canvas.height); ctx.stroke();

            ctx.strokeStyle = '#4444ff'; ctx.shadowColor = '#4444ff';
            ctx.beginPath(); ctx.moveTo(rightLineX, 0); ctx.lineTo(rightLineX, canvas.height); ctx.stroke();

            ctx.strokeStyle = '#44ff44'; ctx.shadowColor = '#44ff44';
            ctx.beginPath(); ctx.moveTo(0, topLineY); ctx.lineTo(canvas.width, topLineY); ctx.stroke();

            ctx.strokeStyle = '#ffaa44'; ctx.shadowColor = '#ffaa44';
            ctx.beginPath(); ctx.moveTo(0, bottomLineY); ctx.lineTo(canvas.width, bottomLineY); ctx.stroke();
        }

        const lineHeight = 100;

        // R ve L √ßizgileri
        ctx.strokeStyle = '#ff66aa'; ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = '#ff66aa';
        ctx.beginPath(); ctx.moveTo(rLineX, rLineY - lineHeight); ctx.lineTo(rLineX, rLineY); ctx.stroke();

        ctx.strokeStyle = '#66aaff'; ctx.shadowColor = '#66aaff';
        ctx.beginPath(); ctx.moveTo(lLineX, lLineY - lineHeight); ctx.lineTo(lLineX, lLineY); ctx.stroke();

        // Artƒ± i≈üaretleri ve √ßemberler
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'white';

        const crossSize = 7;
        const rCrossTop = rLineY - lineHeight - 20;
        const lCrossTop = lLineY - lineHeight - 20;

        // Sarƒ± √ßemberler
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = 2;
        ctx.shadowBlur = 8;
        ctx.shadowColor = '#ffff00';
        ctx.beginPath();
        ctx.arc(rLineX, rCrossTop, crossSize + 15, 0, Math.PI * 2);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(lLineX, lCrossTop, crossSize + 15, 0, Math.PI * 2);
        ctx.stroke();

        // Beyaz artƒ± i≈üaretleri       
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'white';
        ctx.lineCap = 'round'; // Daha temiz √ßizgiler i√ßin


        ctx.beginPath();
        ctx.moveTo(rLineX - crossSize, rCrossTop);
        ctx.lineTo(rLineX + crossSize, rCrossTop);
        ctx.moveTo(rLineX, rCrossTop - crossSize);
        ctx.lineTo(rLineX, rCrossTop + crossSize);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(lLineX - crossSize, lCrossTop);
        ctx.lineTo(lLineX + crossSize, lCrossTop);
        ctx.moveTo(lLineX, lCrossTop - crossSize);
        ctx.lineTo(lLineX, lCrossTop + crossSize);
        ctx.stroke();

        ctx.shadowBlur = 0;

        // Kalibrasyon yapƒ±ldƒ±ysa cetvel √ßiz
        if (isCalibrated) {
            drawRuler(rLineX, rCrossTop, lLineX, lCrossTop, calibrationMM);
        }


        // Beyaz daire tutama√ßlar
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        const radius = 4;
        ctx.beginPath(); ctx.arc(leftLineX, topLineY, radius, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(rightLineX, topLineY, radius, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(leftLineX, bottomLineY, radius, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(rightLineX, bottomLineY, radius, 0, Math.PI * 2); ctx.fill();

        // Kalibrasyon yapƒ±ldƒ±ysa kutula
        if (isCalibrated) {
            kutula();
        }

        // Cam efekti uygula (eƒüer a√ßƒ±ksa)
        if (camEnabled && isCalibrated) {
            applyGlassesEffect();
        }
    }

    //cam se√ßili ise diƒüerleni gizler
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (imageLoaded && loadedImage) {
            ctx.drawImage(
                loadedImage,
                imageScale.x,
                imageScale.y,
                imageScale.width,
                imageScale.height
            );
        }

        // KALƒ∞BRASYON YAPILMAMI≈ûSA REFERANS √áƒ∞ZGƒ∞LERƒ∞ (HER ZAMAN)
        if (!isCalibrated) {
            ctx.strokeStyle = '#ff4444'; ctx.lineWidth = 3; ctx.shadowBlur = 20; ctx.shadowColor = '#ff4444';
            ctx.beginPath(); ctx.moveTo(leftLineX, 0); ctx.lineTo(leftLineX, canvas.height); ctx.stroke();

            ctx.strokeStyle = '#4444ff'; ctx.shadowColor = '#4444ff';
            ctx.beginPath(); ctx.moveTo(rightLineX, 0); ctx.lineTo(rightLineX, canvas.height); ctx.stroke();

            ctx.strokeStyle = '#44ff44'; ctx.shadowColor = '#44ff44';
            ctx.beginPath(); ctx.moveTo(0, topLineY); ctx.lineTo(canvas.width, topLineY); ctx.stroke();

            ctx.strokeStyle = '#ffaa44'; ctx.shadowColor = '#ffaa44';
            ctx.beginPath(); ctx.moveTo(0, bottomLineY); ctx.lineTo(canvas.width, bottomLineY); ctx.stroke();
        }

        // R ve L √ßizgileri - SADECE CAM KAPALIYSA (KALƒ∞BRASYON √ñNCESƒ∞ VE SONRASI)
        if (!camEnabled) {
            const lineHeight = 100;

            // R ve L √ßizgileri
            ctx.strokeStyle = '#ff66aa'; ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = '#ff66aa';
            ctx.beginPath(); ctx.moveTo(rLineX, rLineY - lineHeight); ctx.lineTo(rLineX, rLineY); ctx.stroke();

            ctx.strokeStyle = '#66aaff'; ctx.shadowColor = '#66aaff';
            ctx.beginPath(); ctx.moveTo(lLineX, lLineY - lineHeight); ctx.lineTo(lLineX, lLineY); ctx.stroke();



            const crossSize = 7;
            const rCrossTop = rLineY - lineHeight - 20;
            const lCrossTop = lLineY - lineHeight - 20;

            // Sarƒ± √ßemberler
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#ffff00';
            ctx.beginPath();
            ctx.arc(rLineX, rCrossTop, crossSize + 15, 0, Math.PI * 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(lLineX, lCrossTop, crossSize + 15, 0, Math.PI * 2);
            ctx.stroke();

            // Beyaz artƒ± i≈üaretleri
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'white';


            ctx.beginPath();
            ctx.moveTo(rLineX - crossSize, rCrossTop);
            ctx.lineTo(rLineX + crossSize, rCrossTop);
            ctx.moveTo(rLineX, rCrossTop - crossSize);
            ctx.lineTo(rLineX, rCrossTop + crossSize);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(lLineX - crossSize, lCrossTop);
            ctx.lineTo(lLineX + crossSize, lCrossTop);
            ctx.moveTo(lLineX, lCrossTop - crossSize);
            ctx.lineTo(lLineX, lCrossTop + crossSize);
            ctx.stroke();

            ctx.shadowBlur = 0;

            // Cetvel - SADECE KALƒ∞BRE EDƒ∞LMƒ∞≈ûSE
            if (isCalibrated) {
                drawRuler(rLineX, rCrossTop, lLineX, lCrossTop, calibrationMM);
            }

            // Beyaz daire tutama√ßlar - SADECE KALƒ∞BRE EDƒ∞LMEMƒ∞≈ûSE
            if (!isCalibrated) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                const radius = 4;
                ctx.beginPath(); ctx.arc(leftLineX, topLineY, radius, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(rightLineX, topLineY, radius, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(leftLineX, bottomLineY, radius, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(rightLineX, bottomLineY, radius, 0, Math.PI * 2); ctx.fill();
            }
        }

        // Kalibrasyon yapƒ±ldƒ±ysa kutula - SADECE CAM KAPALIYSA
        if (isCalibrated && !camEnabled) {
            kutula();
        }

        // Canvas √ºzerine √∂l√ß√ºm bilgileri yaz
        if (isCalibrated) {
            drawMeasurementsOnCanvas();
        }

        // Cam efekti uygula (eƒüer a√ßƒ±ksa)
        if (camEnabled && isCalibrated) {
            applyGlassesEffect();
        }
        
        if (!isCalibrated){
         // Kutu √ßiz (kesikli √ßizgi)
            ctx.setLineDash([10, 10]);
            ctx.strokeStyle = 'rgba(255,255,255,0.6)';
            ctx.lineWidth = 3;
            ctx.strokeRect(leftLineX, topLineY, rightLineX - leftLineX, bottomLineY - topLineY);
            ctx.setLineDash([]);
        }
    }


    // ----------------------------------------------------
    // S√úR√úKLEME FONKSƒ∞YONLARI
    // ----------------------------------------------------

    function startDrag(handle, e) {
        e.preventDefault();
        dragging = handle;

        const touch = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        dragOffsetX = 0;
        dragOffsetY = 0;

        if (handle === 'left') {
            dragOffsetX = x - leftLineX;
        } else if (handle === 'right') {
            dragOffsetX = x - rightLineX;
        } else if (handle === 'top') {
            dragOffsetY = y - topLineY;
        } else if (handle === 'bottom') {
            dragOffsetY = y - bottomLineY;
        } else if (handle === 'r') {
            dragOffsetX = x - rLineX;
            dragOffsetY = y - rLineY;
        } else if (handle === 'l') {
            dragOffsetX = x - lLineX;
            dragOffsetY = y - lLineY;
        }
    }

    function onMove(e) {
        if (!dragging) return;

        const touch = e.touches ? e.touches[0] : e;
        const rect = canvasArea.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        const maxWidth = canvas.width;
        const maxHeight = canvas.height;

        if (dragging === 'left') {
            leftLineX = Math.max(0, Math.min(x - dragOffsetX, maxWidth));
        } else if (dragging === 'right') {
            rightLineX = Math.max(0, Math.min(x - dragOffsetX, maxWidth));
        } else if (dragging === 'top') {
            topLineY = Math.max(0, Math.min(y - dragOffsetY, maxHeight));
        } else if (dragging === 'bottom') {
            bottomLineY = Math.max(0, Math.min(y - dragOffsetY, maxHeight));
        } else if (dragging === 'r') {
            rLineX = Math.max(0, Math.min(x - dragOffsetX, maxWidth));
            rLineY = Math.max(0, Math.min(y - dragOffsetY, maxHeight));
        } else if (dragging === 'l') {
            lLineX = Math.max(0, Math.min(x - dragOffsetX, maxWidth));
            lLineY = Math.max(0, Math.min(y - dragOffsetY, maxHeight));
        }

        updateHandles();
        draw();
        calculateMeasurements();

        if (isCalibrated) {
            kutula();
        }
    }

    function endDrag() {
        dragging = null;
        dragOffsetX = 0;
        dragOffsetY = 0;
    }

    // ----------------------------------------------------
    // EVENT LISTENERS
    // ----------------------------------------------------

    leftHandle.addEventListener('mousedown', (e) => startDrag('left', e));
    leftHandle.addEventListener('touchstart', (e) => startDrag('left', e));
    rightHandle.addEventListener('mousedown', (e) => startDrag('right', e));
    rightHandle.addEventListener('touchstart', (e) => startDrag('right', e));
    topHandle.addEventListener('mousedown', (e) => startDrag('top', e));
    topHandle.addEventListener('touchstart', (e) => startDrag('top', e));
    bottomHandle.addEventListener('mousedown', (e) => startDrag('bottom', e));
    bottomHandle.addEventListener('touchstart', (e) => startDrag('bottom', e));
    rHandle.addEventListener('mousedown', (e) => startDrag('r', e));
    rHandle.addEventListener('touchstart', (e) => startDrag('r', e));
    lHandle.addEventListener('mousedown', (e) => startDrag('l', e));
    lHandle.addEventListener('touchstart', (e) => startDrag('l', e));

    document.addEventListener('mousemove', onMove);
    document.addEventListener('touchmove', onMove);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    const ekartmanMinus = document.getElementById('ekartman-minus');
    const ekartmanPlus = document.getElementById('ekartman-plus');
    const kopruMinus = document.getElementById('kopru-minus');
    const kopruPlus = document.getElementById('kopru-plus');

    ekartmanMinus.addEventListener('mousedown', (e) => startChange(-1, 'ekartman', e));
    ekartmanMinus.addEventListener('touchstart', (e) => startChange(-1, 'ekartman', e));
    ekartmanPlus.addEventListener('mousedown', (e) => startChange(1, 'ekartman', e));
    ekartmanPlus.addEventListener('touchstart', (e) => startChange(1, 'ekartman', e));

    kopruMinus.addEventListener('mousedown', (e) => startChange(-1, 'kopru', e));
    kopruMinus.addEventListener('touchstart', (e) => startChange(-1, 'kopru', e));
    kopruPlus.addEventListener('mousedown', (e) => startChange(1, 'kopru', e));
    kopruPlus.addEventListener('touchstart', (e) => startChange(1, 'kopru', e));

    const calibrateBtn = document.getElementById('calibrate-button');
    calibrateBtn.addEventListener('click', calibrate);

    const cameraBtn = document.getElementById('open-camera-button');
    const cameraInput = document.getElementById('camera-input');
    cameraBtn.addEventListener('click', openCamera);
    cameraInput.addEventListener('change', handleImageUpload);

    // CAM EVENT LISTENERS
    const camToggleBtn = document.getElementById('cam-toggle-button');
    const camDiameterMinus = document.getElementById('cam-diameter-minus');
    const camDiameterPlus = document.getElementById('cam-diameter-plus');

    camToggleBtn.addEventListener('click', toggleCam);
    camDiameterMinus.addEventListener('click', () => changeCamDiameter(-1));
    camDiameterPlus.addEventListener('click', () => changeCamDiameter(1));

    // Cam s√ºr√ºkleme event listener'larƒ±
    canvas.addEventListener('mousedown', startCamDrag);
    canvas.addEventListener('mousemove', dragCam);
    canvas.addEventListener('mouseup', endCamDrag);
    canvas.addEventListener('mouseleave', endCamDrag);


    // fullscreen butonu
    /*
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Tam ekran hatasƒ±: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    });
    */

    // Sayfa yenileme butonu
    document.getElementById('reload-btn').addEventListener('click', () => {
        location.reload();

    });



    // SADECE CAM ƒ∞√áƒ∞N TOUCH EVENT'LER - Dƒ∞ƒûER NESNELERƒ∞ BOZMAZ
    canvas.addEventListener('touchstart', function (e) {
        if (!camEnabled) return; // Cam kapalƒ±ysa diƒüer touch event'ler √ßalƒ±≈üsƒ±n

        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();

        // Touch koordinatlarƒ±nƒ± al
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        // Canvas koordinatlarƒ±na d√∂n√º≈üt√ºr
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = x * scaleX;
        const canvasY = y * scaleY;

        const pixelToMM = calibrationMM / calibrationPixels;
        const radiusPixels = (camDiameterMM / 2) / pixelToMM;

        // SADECE CAM i√ßinde mi kontrol et
        const dist = Math.sqrt(Math.pow(canvasX - camX, 2) + Math.pow(canvasY - camY, 2));
        if (dist <= radiusPixels) {
            isCamDragging = true;
            camDragOffsetX = canvasX - camX;
            camDragOffsetY = canvasY - camY;

            // Hemen draw √ßaƒüƒ±r ki feedback olsun
            draw();

            // Diƒüer touch event'lerin √ßalƒ±≈ümasƒ±nƒ± ENGELLE
            e.stopPropagation();
        }
    });

    canvas.addEventListener('touchmove', function (e) {
        if (!isCamDragging || !camEnabled) return;

        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();

        // Touch koordinatlarƒ±nƒ± al
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        // Canvas koordinatlarƒ±na d√∂n√º≈üt√ºr
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = x * scaleX;
        const canvasY = y * scaleY;

        // Cam pozisyonunu g√ºncelle
        camX = canvasX - camDragOffsetX;
        camY = canvasY - camDragOffsetY;

        // Ekranƒ± g√ºncelle
        draw();

        // Diƒüer touch event'lerin √ßalƒ±≈ümasƒ±nƒ± ENGELLE
        e.stopPropagation();
    });

    canvas.addEventListener('touchend', function (e) {
        if (isCamDragging) {
            e.preventDefault();
            isCamDragging = false;
            e.stopPropagation();
        }
    });

    canvas.addEventListener('touchcancel', function (e) {
        if (isCamDragging) {
            e.preventDefault();
            isCamDragging = false;
            e.stopPropagation();
        }
    });

    document.getElementById('progressive-design-select').addEventListener('change', function (e) {
        const selectedValue = e.target.value;

        if (selectedValue && progressiveDesigns[selectedValue]) {
            currentProgressiveDesign = selectedValue;
            console.log('Progressive tasarƒ±m deƒüi≈ütirildi:', selectedValue);

            // Eƒüer cam a√ßƒ±ksa, hemen √ßizimi g√ºncelle
            if (camEnabled) {
                draw();
            }

            // Se√ßim yapƒ±ldƒ±ƒüƒ±nda cam'ƒ± otomatik a√ß (opsiyonel)
            if (!camEnabled) {
                toggleCam();
            }
        } else {
            console.warn('Ge√ßersiz tasarƒ±m se√ßildi:', selectedValue);
            // Varsayƒ±lan deƒüere d√∂n
            currentProgressiveDesign = 'standart';
            e.target.value = 'standart';
        }
    });

    // Sayfa y√ºklendiƒüinde elementleri kontrol et
    window.addEventListener('load', function () {
        console.log('Progressive selector element:', document.getElementById('progressiveSelector'));
        console.log('Cam container element:', document.getElementById('camToggleContainer'));

        // Varsayƒ±lan tasarƒ±mƒ± ayarla
        currentProgressiveDesign = 'standart';
        const selectElement = document.getElementById('progressive-design-select');
        if (selectElement) {
            selectElement.value = 'standart';
        }
    });











    document.getElementById('save-button').addEventListener('click', function () {
        const patientName = document.getElementById('patient-name-input').value.trim();

        if (!patientName) {
            alert('‚ö†Ô∏è L√ºtfen hasta adƒ± soyadƒ± girin!');
            return;
        }

        if (!isCalibrated) {
            alert('‚ö†Ô∏è L√ºtfen √∂nce kalibrasyon yapƒ±n!');
            return;
        }

        // Yeni bir canvas olu≈ütur
        const exportCanvas = document.createElement('canvas');
        const exportCtx = exportCanvas.getContext('2d');

        // Canvas boyutlarƒ±
        exportCanvas.width = canvas.width;
        exportCanvas.height = canvas.height;

        // Arka plan
        exportCtx.fillStyle = '#1a1a1a';
        exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

        // Mevcut canvas'ƒ± √ßiz
        exportCtx.drawImage(canvas, 0, 0);

        // HEADER Bƒ∞LGƒ∞LERƒ∞Nƒ∞ √áƒ∞Z (√úst kƒ±sƒ±m)
        exportCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        exportCtx.fillRect(0, 0, exportCanvas.width, 60);

        exportCtx.fillStyle = 'white';
        exportCtx.font = 'bold 14px Arial';
        exportCtx.fillText(`Ekartman: ${ekartmanValue}  K√∂pr√º: ${kopruValue}  Geni≈ülik: ${document.getElementById('frameWidth').textContent}`, 20, 35);

        // FOOTER Bƒ∞LGƒ∞LERƒ∞Nƒ∞ √áƒ∞Z (Alt kƒ±sƒ±m)
        const footerY = exportCanvas.height - 140;
        exportCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        exportCtx.fillRect(0, footerY, exportCanvas.width, 140);

        exportCtx.fillStyle = '#ff66aa';
        exportCtx.font = 'bold 13px Arial';
        exportCtx.fillText(`Saƒü PD: ${document.getElementById('right-pd-result').textContent}`, 20, footerY + 25);
        exportCtx.fillText(`Saƒü Montaj Y√ºk.: ${document.getElementById('right-montage-result').textContent}`, 20, footerY + 50);

        exportCtx.fillStyle = '#66aaff';
        exportCtx.fillText(`Sol PD: ${document.getElementById('left-pd-result').textContent}`, 20, footerY + 75);
        exportCtx.fillText(`Sol Montaj Y√ºk.: ${document.getElementById('left-montage-result').textContent}`, 20, footerY + 100);

        exportCtx.fillStyle = 'white';
        exportCtx.font = 'bold 14px Arial';
        const pixelToMM = calibrationMM / calibrationPixels;
        const widthPixels = Math.abs(rightLineX - leftLineX) - 3;
        const widthMM = (widthPixels * pixelToMM).toFixed(2).replace('.', ',');
        const heightPixels = Math.abs(bottomLineY - topLineY) - 3;
        const heightMM = (heightPixels * pixelToMM).toFixed(2).replace('.', ',');
        exportCtx.fillText(`Geni≈ülik: ${widthMM} mm | Y√ºkseklik: ${heightMM} mm`, 20, footerY + 125);

        // Hasta adƒ±nƒ± saƒü √ºste ekle
        exportCtx.fillStyle = 'white';
        exportCtx.font = 'bold 16px Arial';
        exportCtx.textAlign = 'right';
        exportCtx.fillText(patientName, exportCanvas.width - 20, 35);

        // ƒ∞ndir
        const dataURL = exportCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `${patientName}_olcum.png`;
        link.href = dataURL;
        link.click();

        alert(`‚úì ${patientName} i√ßin √∂l√ß√ºm kaydedildi!`);
    });

    resizeCanvas();
</script>
</body>

</html>
