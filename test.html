<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PD √ñl√ß√ºm Uygulamasƒ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Buton Stilleri */
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: block;
            margin: 20px auto;
            min-width: 200px;
        }
        
        .btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:not(:disabled):hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-capture {
            background: #ff9800;
            color: white;
        }
        
        .btn-capture:not(:disabled):hover {
            background: #e68900;
        }
        
        /* Durum mesajƒ± */
        .status {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.loading {
            color: #ff9800;
        }
        
        .status.ready {
            color: #4CAF50;
        }
        
        /* Video container */
        .video-container {
            position: relative;
            display: none;
            max-width: 640px;
            margin: 0 auto 20px;
            background: black;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .video-container.active {
            display: block;
        }
        
        #videoElement {
            width: 100%;
            display: block;
        }
        
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* Capture container */
        .capture-container {
            position: relative;
            display: none;
            max-width: 640px;
            margin: 0 auto 20px;
            background: black;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .capture-container.active {
            display: block;
        }
        
        #captureCanvas {
            width: 100%;
            display: block;
            cursor: crosshair;
        }
        
        /* Tutacaklar */
        .handle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 3px solid white;
            transition: transform 0.1s;
            z-index: 10;
        }
        
        .handle:active {
            cursor: grabbing;
            transform: scale(1.15);
        }
        
        #leftHandle { background: #ff4444; }
        #rightHandle { background: #4444ff; }
        #topHandle { background: #44ff44; }
        #bottomHandle { background: #ffaa44; }
        #leftEyeHandle { background: #ff00ff; }
        #rightEyeHandle { background: #00ffff; }
        
        /* Sonu√ß paneli */
        .results {
            display: none;
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 20px;
        }
        
        .results.active {
            display: block;
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .result-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        
        .result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Input grup */
        .input-group {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 5px;
            width: 150px;
            text-align: center;
        }
        
        /* Talimatlar */
        .instructions {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            color: #555;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìè Pupil Distance (PD) √ñl√ß√ºm Uygulamasƒ±</h1>
        
        <!-- Durum mesajƒ± -->
        <div id="status" class="status loading">
            K√ºt√ºphaneler y√ºkleniyor...
        </div>
        
        <!-- Ba≈ülat butonu -->
        <button id="startBtn" class="btn btn-primary" disabled>
            üì∑ Kamerayƒ± A√ß
        </button>
        
        <!-- Talimatlar -->
        <div class="instructions">
            <h3>üìã Kullanƒ±m Talimatlarƒ±</h3>
            <ol>
                <li>G√∂zl√ºƒü√ºn√ºz√º takƒ±n ve kameraya doƒürudan bakƒ±n</li>
                <li>"Kamerayƒ± A√ß" butonuna basƒ±n (arka kamera a√ßƒ±lacak)</li>
                <li>Ye≈üil noktalar g√∂z bebeklerinizi takip edecek</li>
                <li>Hazƒ±r olduƒüunuzda "PD √ñl√ß√ºs√º Al" butonuna basƒ±n</li>
                <li>√áer√ßevenizi renkli dairelerle kutulayƒ±n</li>
                <li>Gerekirse g√∂z bebeklerini mor/turkuaz dairelerle ayarlayƒ±n</li>
                <li>Sonu√ßlar otomatik hesaplanacak</li>
            </ol>
        </div>
        
        <!-- Video container -->
        <div id="videoContainer" class="video-container">
            <video id="videoElement" playsinline></video>
            <canvas id="overlayCanvas"></canvas>
        </div>
        
        <!-- Capture butonu -->
        <button id="captureBtn" class="btn btn-capture" style="display: none;">
            üì∏ PD √ñl√ß√ºs√º Al
        </button>
        
        <!-- Capture container -->
        <div id="captureContainer" class="capture-container">
            <canvas id="captureCanvas"></canvas>
            <!-- √áer√ßeve tutacaklarƒ± -->
            <div id="leftHandle" class="handle">üî¥</div>
            <div id="rightHandle" class="handle">üîµ</div>
            <div id="topHandle" class="handle">üü¢</div>
            <div id="bottomHandle" class="handle">üü†</div>
            <!-- G√∂z tutacaklarƒ± -->
            <div id="leftEyeHandle" class="handle">üü£</div>
            <div id="rightEyeHandle" class="handle">üî∑</div>
        </div>
        
        <!-- √áer√ßeve geni≈üliƒüi input -->
        <div id="frameInput" class="input-group" style="display: none;">
            <label for="frameWidth">G√∂zl√ºk √áer√ßevesi Ger√ßek Geni≈üliƒüi (mm):</label>
            <input type="number" id="frameWidth" value="140" min="100" max="200" step="1">
            <button id="calculateBtn" class="btn btn-primary" style="margin-top: 15px;">
                üßÆ PD Hesapla
            </button>
        </div>
        
        <!-- Sonu√ßlar -->
        <div id="results" class="results">
            <h2>üìä √ñl√ß√ºm Sonu√ßlarƒ±</h2>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Sol G√∂z PD</div>
                    <div class="result-value"><span id="leftPD">--</span> mm</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Saƒü G√∂z PD</div>
                    <div class="result-value"><span id="rightPD">--</span> mm</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Toplam PD</div>
                    <div class="result-value"><span id="totalPD">--</span> mm</div>
                </div>
                <div class="result-item">
                    <div class="result-label">√áer√ßeve Geni≈üliƒüi</div>
                    <div class="result-value"><span id="frameWidthResult">--</span> px</div>
                </div>
                <div class="result-item">
                    <div class="result-label">√áer√ßeve Y√ºksekliƒüi</div>
                    <div class="result-value"><span id="frameHeightResult">--</span> px</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Piksel/mm Oranƒ±</div>
                    <div class="result-value"><span id="pixelRatio">--</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let faceMesh;
        let camera;
        let isLibrariesReady = false;
        let currentPupils = null;
        let capturedImage = null;
        
        // Marker pozisyonlarƒ±
        const markers = {
            leftEdgeX: 0,
            rightEdgeX: 0,
            topY: 0,
            bottomY: 0,
            leftEyeX: 0,
            leftEyeY: 0,
            rightEyeX: 0,
            rightEyeY: 0
        };
        
        let dragging = null;
        
        // DOM elementleri
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const videoContainer = document.getElementById('videoContainer');
        const videoElement = document.getElementById('videoElement');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const captureContainer = document.getElementById('captureContainer');
        const captureCanvas = document.getElementById('captureCanvas');
        const frameInput = document.getElementById('frameInput');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsEl = document.getElementById('results');
        
        // Tutacaklar
        const handles = {
            left: document.getElementById('leftHandle'),
            right: document.getElementById('rightHandle'),
            top: document.getElementById('topHandle'),
            bottom: document.getElementById('bottomHandle'),
            leftEye: document.getElementById('leftEyeHandle'),
            rightEye: document.getElementById('rightEyeHandle')
        };
        
        // MediaPipe y√ºkleme
        function initMediaPipe() {
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            faceMesh.onResults(onResults);
            
            faceMesh.initialize().then(() => {
                isLibrariesReady = true;
                statusEl.textContent = '‚úÖ Hazƒ±r! Kamerayƒ± a√ßabilirsiniz';
                statusEl.className = 'status ready';
                startBtn.disabled = false;
            });
        }
        
        // Sonu√ßlarƒ± i≈üle
        function onResults(results) {
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // Sol g√∂z bebeƒüi (landmark 468)
                const leftPupil = landmarks[468];
                // Saƒü g√∂z bebeƒüi (landmark 473)
                const rightPupil = landmarks[473];
                
                currentPupils = {
                    left: {
                        x: leftPupil.x * overlayCanvas.width,
                        y: leftPupil.y * overlayCanvas.height
                    },
                    right: {
                        x: rightPupil.x * overlayCanvas.width,
                        y: rightPupil.y * overlayCanvas.height
                    }
                };
                
                // G√∂z bebeklerini √ßiz
                ctx.fillStyle = '#00ff00';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00ff00';
                
                ctx.beginPath();
                ctx.arc(currentPupils.left.x, currentPupils.left.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(currentPupils.right.x, currentPupils.right.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowBlur = 0;
            }
        }
        
        // Kamerayƒ± ba≈ülat
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Arka kamera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    
                    // Canvas boyutlarƒ±nƒ± ayarla
                    overlayCanvas.width = videoElement.videoWidth;
                    overlayCanvas.height = videoElement.videoHeight;
                    
                    videoContainer.classList.add('active');
                    captureBtn.style.display = 'block';
                    startBtn.style.display = 'none';
                    statusEl.textContent = 'üìπ Kamera aktif - G√∂z bebekleriniz ye≈üil noktalarla i≈üaretleniyor';
                    
                    // MediaPipe'ƒ± ba≈ülat
                    camera = new Camera(videoElement, {
                        onFrame: async () => {
                            await faceMesh.send({image: videoElement});
                        },
                        width: 1280,
                        height: 720
                    });
                    camera.start();
                };
            } catch (error) {
                alert('Kamera eri≈üimi reddedildi: ' + error.message);
            }
        });
        
        // Fotoƒüraf √ßek
        captureBtn.addEventListener('click', () => {
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            
            const ctx = captureCanvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0);
            
            // G√∂z bebeklerini kaydet
            if (currentPupils) {
                markers.leftEyeX = currentPupils.left.x;
                markers.leftEyeY = currentPupils.left.y;
                markers.rightEyeX = currentPupils.right.x;
                markers.rightEyeY = currentPupils.right.y;
            }
            
            // Ba≈ülangƒ±√ß √ßer√ßeve pozisyonlarƒ±
            markers.leftEdgeX = captureCanvas.width * 0.25;
            markers.rightEdgeX = captureCanvas.width * 0.75;
            markers.topY = captureCanvas.height * 0.3;
            markers.bottomY = captureCanvas.height * 0.7;
            
            updateHandles();
            
            // Kamerayƒ± kapat
            if (camera) camera.stop();
            videoContainer.classList.remove('active');
            captureBtn.style.display = 'none';
            
            // Capture modunu a√ß
            captureContainer.classList.add('active');
            frameInput.style.display = 'block';
            statusEl.textContent = 'üéØ √áer√ßeveyi ve g√∂z bebeklerini ayarlayƒ±n';
            
            drawOverlay();
        });
        
        // Tutacaklarƒ± g√ºncelle
        function updateHandles() {
            const rect = captureCanvas.getBoundingClientRect();
            const scaleX = rect.width / captureCanvas.width;
            const scaleY = rect.height / captureCanvas.height;
            
            handles.left.style.left = (markers.leftEdgeX * scaleX) + 'px';
            handles.left.style.top = ((markers.topY + markers.bottomY) / 2 * scaleY) + 'px';
            handles.left.style.transform = 'translate(-50%, -50%)';
            
            handles.right.style.left = (markers.rightEdgeX * scaleX) + 'px';
            handles.right.style.top = ((markers.topY + markers.bottomY) / 2 * scaleY) + 'px';
            handles.right.style.transform = 'translate(-50%, -50%)';
            
            handles.top.style.left = ((markers.leftEdgeX + markers.rightEdgeX) / 2 * scaleX) + 'px';
            handles.top.style.top = (markers.topY * scaleY) + 'px';
            handles.top.style.transform = 'translate(-50%, -50%)';
            
            handles.bottom.style.left = ((markers.leftEdgeX + markers.rightEdgeX) / 2 * scaleX) + 'px';
            handles.bottom.style.top = (markers.bottomY * scaleY) + 'px';
            handles.bottom.style.transform = 'translate(-50%, -50%)';
            
            handles.leftEye.style.left = (markers.leftEyeX * scaleX) + 'px';
            handles.leftEye.style.top = (markers.leftEyeY * scaleY) + 'px';
            handles.leftEye.style.transform = 'translate(-50%, -50%)';
            
            handles.rightEye.style.left = (markers.rightEyeX * scaleX) + 'px';
            handles.rightEye.style.top = (markers.rightEyeY * scaleY) + 'px';
            handles.rightEye.style.transform = 'translate(-50%, -50%)';
        }
        
        // Overlay √ßiz
        function drawOverlay() {
            const ctx = captureCanvas.getContext('2d');
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = captureCanvas.width;
            tempCanvas.height = captureCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(captureCanvas, 0, 0);
            
            ctx.drawImage(tempCanvas, 0, 0);
            
            // √áer√ßeve
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.strokeRect(
                markers.leftEdgeX,
                markers.topY,
                markers.rightEdgeX - markers.leftEdgeX,
                markers.bottomY - markers.topY
            );
            ctx.setLineDash([]);
            
            // G√∂z bebekleri
            ctx.fillStyle = '#ff00ff';
            ctx.beginPath();
            ctx.arc(markers.leftEyeX, markers.leftEyeY, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#00ffff';
            ctx.beginPath();
            ctx.arc(markers.rightEyeX, markers.rightEyeY, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // Merkez √ßizgisi
            const centerX = (markers.leftEdgeX + markers.rightEdgeX) / 2;
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, captureCanvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // S√ºr√ºkleme
        function startDrag(handle, e) {
            e.preventDefault();
            dragging = handle;
        }
        
        function onMove(e) {
            if (!dragging) return;
            
            const rect = captureCanvas.getBoundingClientRect();
            const scaleX = captureCanvas.width / rect.width;
            const scaleY = captureCanvas.height / rect.height;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            if (dragging === 'left') {
                markers.leftEdgeX = Math.max(0, Math.min(x, captureCanvas.width));
            } else if (dragging === 'right') {
                markers.rightEdgeX = Math.max(0, Math.min(x, captureCanvas.width));
            } else if (dragging === 'top') {
                markers.topY = Math.max(0, Math.min(y, captureCanvas.height));
            } else if (dragging === 'bottom') {
                markers.bottomY = Math.max(0, Math.min(y, captureCanvas.height));
            } else if (dragging === 'leftEye') {
                markers.leftEyeX = Math.max(0, Math.min(x, captureCanvas.width));
                markers.leftEyeY = Math.max(0, Math.min(y, captureCanvas.height));
            } else if (dragging === 'rightEye') {
                markers.rightEyeX = Math.max(0, Math.min(x, captureCanvas.width));
                markers.rightEyeY = Math.max(0, Math.min(y, captureCanvas.height));
            }
            
            updateHandles();
            drawOverlay();
        }
        
        function endDrag() {
            dragging = null;
        }
        
        // Event listeners
        Object.keys(handles).forEach(key => {
            handles[key].addEventListener('mousedown', (e) => startDrag(key, e));
            handles[key].addEventListener('touchstart', (e) => startDrag(key, e));
        });
        
        document.addEventListener('mousemove', onMove);
        document.addEventListener('touchmove', onMove);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        
        // PD Hesapla
        calculateBtn.addEventListener('click', () => {
            const realFrameWidth = parseFloat(document.getElementById('frameWidth').value);
            
            const frameWidthPixels = markers.rightEdgeX - markers.leftEdgeX;
            const frameHeightPixels = markers.bottomY - markers.topY;
            const pixelPerMm = frameWidthPixels / realFrameWidth;
            
            const frameCenterX = (markers.leftEdgeX + markers.rightEdgeX) / 2;
            
            const leftPD_px = Math.abs(frameCenterX - markers.leftEyeX);
            const leftPD_mm = leftPD_px / pixelPerMm;
            
            const rightPD_px = Math.abs(markers.rightEyeX - frameCenterX);
            const rightPD_mm = rightPD_px / pixelPerMm;
            
            const totalPD_px = Math.abs(markers.rightEyeX - markers.leftEyeX);
            const totalPD_mm = totalPD_px / pixelPerMm;
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('leftPD').textContent = leftPD_mm.toFixed(2);
            document.getElementById('rightPD').textContent = rightPD_mm.toFixed(2);
            document.getElementById('totalPD').textContent = totalPD_mm.toFixed(1);
            document.getElementById('frameWidthResult').textContent = frameWidthPixels.toFixed(0);
            document.getElementById('frameHeightResult').textContent = frameHeightPixels.toFixed(0);
            document.getElementById('pixelRatio').textContent = pixelPerMm.toFixed(3);
            
            resultsEl.classList.add('active');
            statusEl.textContent = '‚úÖ √ñl√ß√ºm tamamlandƒ±!';
            statusEl.className = 'status ready';
        });
        
        // Ba≈ülat
        initMediaPipe();
    </script>
</body>
</html>
