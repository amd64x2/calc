const data = {
    "SEIKO": {
        "1.50 SRC": { 
            "price": "4400 TL",
            "info":"info SRC KAPLAMA", 
            "discount": "40%",
            "max-discount":"45%",
            "renk": "Beyaz",
            "index": "1.50",
            "odak": "Tek",
            "hammadde":"CR39", 
            "kaplama":"UV400" 
        },
        "1.57 SCC": { 
            "price": "4200 TL", 
            "info":"info SCC dir", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.56",
            "odak": "Tek",
            "hammadde":"CR39", 
            "kaplama":"UV400" 
        },
        "1.60 SRC": { 
            "price": "8580 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"65%",
            "renk": "Beyaz",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.60 SRC BI-ASPH": { 
            "price": "10220 TL", 
            "info":"KENARLAR yumuşak", 
            "discount": "40%",
            "max-discount":"70%",
            "renk": "Beyaz",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.60 SRB ASPH": { 
            "price": "8700 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "1.67 SRC ASPH": { 
            "price": "13260 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.67",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.67 SRC BI-ASPH": { 
            "price": "12960 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.67",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.74 SRC ASPH": { 
            "price": "19880 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.74",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.74 SRC BI-ASPH": { 
            "price": "22500 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.74",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.50 Sensity": { 
            "price": "18940 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.50",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.50 Sensity 2 RCC": { 
            "price": "20580 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.50",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.60 Sensity 2": { 
            "price": "26040 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.60 Sensity 2 RCC": { 
            "price": "30260 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.67 Sensity 2": { 
            "price": "33480 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.67",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "1.67 Sensity 2 RCC": { 
            "price": "35120 TL", 
            "info":"info------------------------", 
            "discount": "40%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.67",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },



        "logo": "logo/seiko-logo.png"
    },
    "HOYA": {
        "1.60 EYNOA": { 
            "price": "100 TL", 
            "discount": "45%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.56",
            "odak": "Tek",
            "hammadde":"CR39", 
            "kaplama":"UV400" 
        },
        "HOYA2": { 
            "price": "150 TL", 
            "discount": "45%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"UV400" 
        },
        "HOYA3": { 
            "price": "200 TL", 
            "discount": "45%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.67",
            "odak": "Cok",
            "hammadde":"CR39", 
            "kaplama":"Blue" 
        },
        "HOYA4": { 
            "price": "200 TL", 
            "discount": "45%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.74",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "logo": "logo/hoya-logo.png"
    },
    "MAXXEE": {
        "1.57 SCC": { 
            "price": "100 TL", 
            "discount": "50%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.56",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "Product2": { 
            "price": "150 TL", 
            "discount": "50%",
            "max-discount":"60%",
            "renk": "Color",
            "index": "1.60",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "Product3": { 
            "price": "200 TL", 
            "discount": "50%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.67",
            "odak": "Cok",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "Product4": { 
            "price": "200 TL", 
            "discount": "50%",
            "max-discount":"60%",
            "renk": "Beyaz",
            "index": "1.74",
            "odak": "Tek",
            "hammadde":"Kırılmaz", 
            "kaplama":"Blue" 
        },
        "logo": "logo/maxx-logo.png"
    }
};



// Fiyatı binlik ayraçlarla formatlayan fonksiyon
function formatPrice(price) {
    let parts = price.toFixed(2).split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return parts.join(',') + ' TL';
}

//----------------
const discountInput = document.getElementById('discount-input');
const decreaseButton = document.getElementById('decrease-discount');
const increaseButton = document.getElementById('increase-discount');

decreaseButton.addEventListener('click', () => {
    let currentValue = parseInt(discountInput.value) || 0;
    if (currentValue > 0) {
        discountInput.value = Math.max(currentValue - 5, 0);
    }
    applyCustomDiscount(); // İndirim uygulandıktan sonra paneli güncelle
});

increaseButton.addEventListener('click', () => {
    let currentValue = parseInt(discountInput.value) || 0;
    if (currentValue < 50) {
        discountInput.value = Math.min(currentValue + 5, 50);
    }
    applyCustomDiscount(); // İndirim uygulandıktan sonra paneli güncelle
});
//----------------

let currentProductPrice = 0;
let currentMaxDiscount = 0; // Eklenen yeni değişken

function openTab(evt, brandName) { // FİYAT TABLOSUNU GİZLER
    var i, tabcontent, tablinks;

    // Tüm tabcontent'leri gizle
    tabcontent = document.getElementsByClassName("tab-container");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Tüm tablink'leri pasif hale getir
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Seçilen tabcontent'i göster ve aktif tab'ı işaretle
    document.getElementById(brandName).style.display = "block";
    evt.currentTarget.className += " active";

    // Marka logosunu güncelle
    updateBrandLogo(brandName);

    // Fiyat panelindeki bilgileri temizle
    clearPricingPanel();

    // Tabloyu gizle veya göster
    if (brandName === 'Brand4') {
        document.getElementById('pricing-panel').style.display = 'none'; // Tabloyu gizle
    } else {
        document.getElementById('pricing-panel').style.display = 'block'; // Tabloyu göster
    }
}

function updateBrandLogo(brandName) {
    // Tüm logo resimlerini gizle
    const logos = document.querySelectorAll('#brand-logo');
    logos.forEach(logo => {
        logo.style.display = 'none';
    });

    // Seçilen markanın logosunu göster
    const logoElement = document.querySelector(`#${brandName} #brand-logo`);
    if (logoElement) {
        logoElement.src = data[brandName].logo;
        logoElement.style.display = 'block';
    }
}

function clearPricingPanel() {
    document.getElementById('product-name-value').innerText = '-';
    document.getElementById('product-info-value').innerText = '-';
    document.getElementById('product-price-value').innerText = '-';
    document.getElementById('product-discount-value').innerText = '-';
    document.getElementById('discount-input-value').innerText = '-';
    document.getElementById('final-price-value').innerText = '-';  
    document.getElementById('total-price-value').innerText = '-';  
    document.getElementById('discount-input').value = 0; // İskonto alanını sıfırla 
    currentProductPrice = 0; // Fiyatı sıfırla
}



function getProductPrice(brand, product) {
    // JSON verisinden ürün bilgilerini al
    const productData = data[brand][product];
    currentProductPrice = parseFloat(productData.price.replace(' TL', '').replace('.', '').replace(',', '.')); // TL'yi kaldır ve sayıya çevir
    currentMaxDiscount = parseFloat(productData['max-discount'].replace('%', '')); // max-discount değerini al

    // Fiyat ve iskonto bilgisini güncelle
    updatePricingPanel(product, productData.price, productData.discount, productData.info);

    // İskonto oranını JSON dosyasından al ve input alanına yerleştir
    const discountValue = parseFloat(productData.discount.replace('%', '')); // '%' işaretini kaldır ve sayıya çevir
    document.getElementById('discount-input').value = discountValue;

    // İskonto kutusundaki değeri kontrol et ve uygula
    applyCustomDiscount();
}

function updatePricingPanel(productName, productPrice, productDiscount,productInfo) {
    document.getElementById('product-name-value').innerText = productName;
    document.getElementById('product-price-value').innerText = formatPrice(parseFloat(productPrice.replace(' TL', '').replace('.', '').replace(',', '.')));
    document.getElementById('product-discount-value').innerText = productDiscount;
    document.getElementById('product-info-value').innerText = productInfo;
}

function applyCustomDiscount() {
    let customDiscount = parseFloat(document.getElementById('discount-input').value) || 0;
    const cercFiyat = parseFloat(document.getElementById('discount-input-cer').value) || 0;

    if (isNaN(customDiscount)) customDiscount = 0; // Eğer geçersiz bir değer varsa 0'a set et

    // İskonto oranını max-discount değeriyle sınırla
    customDiscount = Math.min(customDiscount, currentMaxDiscount);

    // İskonto oranı yüzdesine göre indirimli fiyatı hesapla
    const discountedPrice = currentProductPrice * (1 - (customDiscount / 100));

    const totalPrice = discountedPrice + cercFiyat;

    // Hesaplanan fiyatı doğru formatta göster
    document.getElementById('final-price-value').innerText = formatPrice(discountedPrice);
    document.getElementById('total-price-value').innerText = formatPrice(totalPrice);
    document.getElementById('product-discount-value').innerText = '%' + customDiscount;
    document.getElementById('discount-input-value').innerText = formatPrice(currentProductPrice - discountedPrice);
    document.getElementById('discount-input').value = customDiscount; // Input değerini güncelle
}

// Ürün butonlarına tıklama olayını dinleyen kodu ekleyin
document.querySelectorAll('.product-button, .product-buttonc, .product-buttonuy, .product-buttonuyc').forEach(button => {
    button.addEventListener('click', function() {
        const brand = button.getAttribute('data-brand');
        const product = button.getAttribute('data-product');
        getProductPrice(brand, product);
    });
});

// İskonto kutusunda değişiklik olduğunda güncelleme yap
document.getElementById('discount-input').addEventListener('input', applyCustomDiscount);
document.getElementById('discount-input-cer').addEventListener('input', applyCustomDiscount);

// İskonto miktarını artıran fonksiyon
function increaseDiscount() {
    let currentValue = parseInt(discountInput.value) || 0;
    if (currentValue < currentMaxDiscount) {
        discountInput.value = Math.min(currentValue + 5, currentMaxDiscount);
    }
    applyCustomDiscount();
}

// İskonto miktarını azaltan fonksiyon (discount-input için)
function decreaseDiscount() {
    let currentValue = parseInt(discountInput.value) || 0;
    if (currentValue > 0) {
        discountInput.value = Math.max(currentValue - 5, 0);
    }
    applyCustomDiscount();
}



// Butonlara tıklama olaylarını ekle
document.getElementById('decrease-discount').addEventListener('click', decreaseDiscount);
document.getElementById('increase-discount').addEventListener('click', increaseDiscount);
document.querySelector('#user-decrease-discount').addEventListener('click', decreaseUserDiscount);
document.querySelector('#user-increase-discount').addEventListener('click', increaseUserDiscount);

// Kullanıcı tarafından girilen iskontoyu al ve tabloyu güncelle
function applyFilters() {
    const checkboxes = document.querySelectorAll('.filter-checkbox');
    const selectedFilters = {};

    // Seçilen checkbox'ları al
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const category = checkbox.closest('div').querySelector('h4').textContent;
            if (!selectedFilters[category]) {
                selectedFilters[category] = [];
            }
            selectedFilters[category].push(checkbox.value);
        }
    });

    // Filtreler seçildiyse tabloyu güncelle, aksi takdirde tabloyu boş bırak
    if (Object.keys(selectedFilters).length > 0) {
        updateTable(selectedFilters);
    } else {
        clearTable();
    }
}


// Tabloyu temizle
function clearTable() {
    const tableBody = document.querySelector('#product-list tbody');
    tableBody.innerHTML = ''; // Tabloyu boşalt
}

// Checkbox'lara ve iskontoya değişiklik olduğunda filtreleri uygula
document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', applyFilters);
});




//-----------------------
// updateTable fonksiyonunu güncelle
function updateTable(filters) {
    const tableBody = document.querySelector('#product-list tbody');
    tableBody.innerHTML = ''; // Tabloyu temizle

    // Kullanıcı tarafından girilen iskontoyu al
    const userDiscountInput = document.querySelector('#user-discount-input');
    const userDiscount = parseFloat(userDiscountInput.value) || 0;

    let tableData = []; // Tablo verilerini tutacak dizi

    for (const brand in data) {
        for (const product in data[brand]) {
            const productData = data[brand][product];

            let matchesFilters = true;

            // Filtreleri kontrol et
            for (const category in filters) {
                if (!filters[category].includes(productData[category.toLowerCase()])) {
                    matchesFilters = false;
                    break;
                }
            }

            // Filtrelere uyan ürünleri diziye ekle
            if (matchesFilters) {
                const price = parseFloat(productData.price.replace(' TL', '').replace('.', ',')); // Remove " TL" and convert to float
                const jsonDiscount = productData.discount ? parseFloat(productData.discount.replace('%', '')) / 100 : 0; // JSON discount
                const maxDiscount = parseFloat(productData['max-discount'].replace('%', '')) / 100; // max-discount
                
                // Kullanıcı iskontosu ve JSON iskontosu arasında büyük olanı seç, max-discount ile sınırla
                const effectiveDiscount = Math.min(Math.max(userDiscount / 100, jsonDiscount), maxDiscount);
                
                const discountedPrice = price * (1 - effectiveDiscount); // Calculate discounted price

                tableData.push({
                    brand,
                    product,
                    renk: productData.renk,
                    index: productData.index,
                    odak: productData.odak,
                    price,
                    jsonDiscount: productData.discount || 'N/A',
                    effectiveDiscount,
                    discountedPrice
                });
            }
        }
    }

    // Tabloyu oluştur
    renderTable(tableData);

    const headers = document.querySelectorAll('#product-list th');
    headers.forEach(header => {
        header.removeEventListener('click', handleSort); // Var olan listener'ı kaldır
        header.addEventListener('click', handleSort); // Tekrar ekle
    });
}

// renderTable fonksiyonunu güncelle
function renderTable(tableData) {
    const tableBody = document.querySelector('#product-list tbody');
    tableBody.innerHTML = '';

    tableData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.brand}</td>
            <td>${row.product}</td>
            <td>${row.renk}</td>
            <td>${row.index}</td>
            <td>${row.odak}</td>
            <td style="text-align: right;">${formatPrice(row.price)}</td>
            <td>${row.jsonDiscount}</td>
            <td>${(row.effectiveDiscount * 100).toFixed(2)}%</td>
            <td style="text-align: right;">${formatPrice(row.discountedPrice)}</td>
        `;

        // BELİRLİ HÜCRELERİ RENKLENDİRMEK İÇİN
        if (row.effectiveDiscount > (parseFloat(row.jsonDiscount.replace('%', '')) / 100)) {
            tr.cells[6].style.backgroundColor = '#aa3434'; // 7. hücreyi renklendir
            tr.cells[7].style.backgroundColor = '#aa3434'; // 8. hücreyi renklendir
        }

        tableBody.appendChild(tr);
    });
}

// İskonto miktarını artıran fonksiyon (user-discount-input için)
function increaseUserDiscount() {
    const userDiscountInput = document.querySelector('#user-discount-input');
    let currentDiscount = parseFloat(userDiscountInput.value) || 35; // Başlangıç değeri 35
    const maxDiscount = 70; // Sabit maksimum değer
    if (currentDiscount < maxDiscount) {
        userDiscountInput.value = Math.min(currentDiscount + 5, maxDiscount); // Her seferinde 5 artır
        applyFilters(); // Filtreleri uygulayarak tabloyu güncelle
    }
}

// İskonto miktarını azaltan fonksiyon (user-discount-input için)
function decreaseUserDiscount() {
    const userDiscountInput = document.querySelector('#user-discount-input');
    let currentDiscount = parseFloat(userDiscountInput.value) || 40; // Başlangıç değeri 40
    
    // İskontoyu 5 azalt
    if (currentDiscount > 0) {
        currentDiscount = Math.max(currentDiscount - 5, 0);
        
        // Eğer değer 40'tan küçükse input alanını boş bırak
        if (currentDiscount < 40) {
            userDiscountInput.value = '';
        } else {
            userDiscountInput.value = currentDiscount; // Aksi takdirde yeni değeri ayarla
        }
        
        applyFilters(); // Filtreleri uygulayarak tabloyu güncelle
    }
}

// Butonlara tıklama olaylarını ekle
document.querySelector('#user-decrease-discount').addEventListener('click', decreaseUserDiscount);
document.querySelector('#user-increase-discount').addEventListener('click', increaseUserDiscount);











function handleSort(event) {
    const column = event.target.dataset.column;
    const currentOrder = event.target.dataset.order || 'asc';
    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    sortTable(column, newOrder);
    
    // Tüm başlıklardan sıralama sınıfını kaldır
    const headers = document.querySelectorAll('#product-list th');
    headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
        header.dataset.order = '';
    });

    // Tıklanan başlığa sıralama yönünü belirten sınıf ekle
    event.target.classList.add(`sort-${newOrder}`);
    event.target.dataset.order = newOrder;
}


function sortTable(column, order) {
    const tableBody = document.querySelector('#product-list tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const sortedRows = rows.sort((a, b) => {
        let aValue = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent.trim();
        let bValue = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent.trim();
        
        // Sayısal değerler için özel işlem
        if (['price', 'effectiveDiscount', 'discountedPrice'].includes(column)) {
            // TL sembolünü kaldır, binlik ayırıcıları kaldır ve virgülü noktaya çevir
            aValue = parseFloat(aValue.replace(/[^\d,]/g, '').replace(',', '.'));
            bValue = parseFloat(bValue.replace(/[^\d,]/g, '').replace(',', '.'));
        } else if (column === 'index') {
            // Index için özel sıralama (örneğin: 1.50, 1.60, 1.67 gibi)
            aValue = parseFloat(aValue);
            bValue = parseFloat(bValue);
        }

        if (isNaN(aValue) && isNaN(bValue)) {
            // Eğer her iki değer de sayı değilse, string olarak karşılaştır
            return order === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        } else if (isNaN(aValue)) {
            // Eğer sadece aValue sayı değilse, onu sona at
            return order === 'asc' ? 1 : -1;
        } else if (isNaN(bValue)) {
            // Eğer sadece bValue sayı değilse, onu sona at
            return order === 'asc' ? -1 : 1;
        }

        // Sayısal karşılaştırma
        return order === 'asc' ? aValue - bValue : bValue - aValue;
    });

    // Sıralanmış satırları tabloya ekle
    tableBody.innerHTML = '';
    sortedRows.forEach(row => tableBody.appendChild(row));
}

function getColumnIndex(column) {
    const columns = ['brand', 'product', 'renk', 'index', 'odak', 'price', 'jsonDiscount', 'effectiveDiscount', 'discountedPrice'];
    return columns.indexOf(column) + 1;
}



// HTML'de tablo başlıklarını güncelle
// <th data-column="brand">MARKA</th>
// <th data-column="product">ÜRÜN ADI</th>
// <th data-column="renk">RENK</th>
// <th data-column="index">İNDEX</th>
// <th data-column="odak">ODAK</th>
// <th data-column="price">FİYAT</th>
// <th data-column="jsonDiscount">İNDİRİM</th>
// <th data-column="effectiveDiscount">UYGULANAN İNDİRİM</th>
// <th data-column="discountedPrice">SON FİYAT</th>
//----------------------

// Sayfa yüklendiğinde filtreleri uygulayıp tabloyu başlat
window.onload = applyFilters;

